<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"security-kitchen.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"./public/search.json"};
  </script>

  <meta name="description" content="一、前言在上篇文章源码编译（2）——Xopsed源码编译详解中详细介绍了Xposed源码编译的完整过程，本文将从Android编译过程到Xposed运行机制，最后进行Xposed框架的详细定制。其中Xposed的定制主要参考世界美景大佬的定制Xposed框架和肉丝大佬的来自高纬的对抗：魔改XPOSED过框架检测(下)。">
<meta property="og:type" content="article">
<meta property="og:title" content="Android源码定制（4）——Xposed源码定制">
<meta property="og:url" content="http://security-kitchen.com/2022/12/04/code4/index.html">
<meta property="og:site_name" content="欢迎来到安全后厨！">
<meta property="og:description" content="一、前言在上篇文章源码编译（2）——Xopsed源码编译详解中详细介绍了Xposed源码编译的完整过程，本文将从Android编译过程到Xposed运行机制，最后进行Xposed框架的详细定制。其中Xposed的定制主要参考世界美景大佬的定制Xposed框架和肉丝大佬的来自高纬的对抗：魔改XPOSED过框架检测(下)。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/1.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/2.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/4.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/3.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/5.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/6.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/7.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/8.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/9.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/10.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/11.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/12.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/18.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/13.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/14.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/15.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/16.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/17.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/19.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/20.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/21.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/22.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/23.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/24.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/25.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/26.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/27.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/28.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/29.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/30.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/31.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/59.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/32.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/33.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/34.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/35.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/36.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/37.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/38.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/39.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/40.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/41.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/42.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/43.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/44.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/45.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/46.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/47.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/48.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/49.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/50.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/51.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/52.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/53.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/54.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/55.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/56.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/57.png">
<meta property="og:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/58.png">
<meta property="article:published_time" content="2022-12-04T14:45:00.000Z">
<meta property="article:modified_time" content="2023-12-23T09:13:44.115Z">
<meta property="article:author" content="安全后厨团队">
<meta property="article:tag" content="逆向技术">
<meta property="article:tag" content="Xposed">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/1.png">

<link rel="canonical" href="http://security-kitchen.com/2022/12/04/code4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Android源码定制（4）——Xposed源码定制 | 欢迎来到安全后厨！</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="欢迎来到安全后厨！" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>
	<div class="headband"></div>
    <a target="_blank" rel="noopener" href="https://github.com/WindXaa?tab=repositories" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">欢迎来到安全后厨！</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-resources">

    <a href="/resources/" rel="section"><i class="fa fa-download fa-fw"></i>资源</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://security-kitchen.com/2022/12/04/code4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="安全后厨团队">
      <meta itemprop="description" content="选择有时候比努力更重要">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="欢迎来到安全后厨！">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Android源码定制（4）——Xposed源码定制
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-12-04 22:45:00" itemprop="dateCreated datePublished" datetime="2022-12-04T22:45:00+08:00">2022-12-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-23 17:13:44" itemprop="dateModified" datetime="2023-12-23T17:13:44+08:00">2023-12-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android%E6%BA%90%E7%A0%81%E5%AE%9A%E5%88%B6/" itemprop="url" rel="index"><span itemprop="name">Android源码定制</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h2><p>在上篇文章<a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-269616.htm">源码编译（2）——Xopsed源码编译详解</a>中详细介绍了Xposed源码编译的完整过程，本文将从Android编译过程到Xposed运行机制，最后进行Xposed框架的详细定制。其中Xposed的定制主要参考世界美景大佬的<a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-255836.htm">定制Xposed框架</a>和肉丝大佬的<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/YAMCrQSi0LFJGNIwB9qHDA">来自高纬的对抗：魔改XPOSED过框架检测(下)</a>。</p>
<span id="more"></span>
<p><strong>致谢：</strong></p>
<p>首先感谢世界美景大佬的<a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-255836.htm">定制Xposed框架</a>，从里面学习到对Xposed框架特征的修改，但是由于个人水平有限，大佬的贴子不够详细，不能完整复现，经过搜索发现肉丝大佬的基于此的两篇详细的贴子讲解：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/c97zoTxRrEeYLvD8YwIUVQ">来自高纬的对抗：魔改XPOSED过框架检测(上)</a>和<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/YAMCrQSi0LFJGNIwB9qHDA">来自高纬的对抗：魔改XPOSED过框架检测(下)</a>，本文的Android系统运行参考<a target="_blank" rel="noopener" href="https://www.kancloud.cn/alex_wsc/androids/472168">老罗的博客</a></p>
<h2 id="二、Android运行机制"><a href="#二、Android运行机制" class="headerlink" title="二、Android运行机制"></a>二、Android运行机制</h2><p>我们在了解Xposed的运行机制前，不得不需要了解Android系统的基本结构和运行机制，这样我们才能进一步学习如何进行Xposed定制，才能减少更多的错误</p>
<h3 id="1-Android平台架构"><a href="#1-Android平台架构" class="headerlink" title="1. Android平台架构"></a>1. Android平台架构</h3><p>Android的平台架构如下图所示：</p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/1.png" alt="image-20211002145934512"></p>
<p>下面我们依次介绍各层之间的功能和作用：</p>
<h4 id="（1）Linux内核"><a href="#（1）Linux内核" class="headerlink" title="（1）Linux内核"></a>（1）Linux内核</h4><p>Android平台的基础是linux内核，Android Runtime（ART）依靠Linux内核来执行底层功能，使用Linux内核可让Android利用主要安全功能，并且运行设备制造商为著名的内核开发硬件驱动程序，可以理解基于linux内核让Android更安全并且可以拥有很多设备驱动</p>
<h4 id="（2）硬件抽象层（HAL）"><a href="#（2）硬件抽象层（HAL）" class="headerlink" title="（2）硬件抽象层（HAL）"></a>（2）硬件抽象层（HAL）</h4><p>HAL提供标准界面，向更高级别Java API框架显示设备硬件功能，HAL包含多个模块，其中每个模块都为特定类型的硬件组件实现一个界面，例如相机和蓝牙模块，当框架API要访问设备硬件时，Android系统为该硬件组件加载库模块。</p>
<h4 id="（3）Android-Runtime"><a href="#（3）Android-Runtime" class="headerlink" title="（3）Android Runtime"></a>（3）Android Runtime</h4><p>Android 5.0之前Android Runtime为Dalvik，Android 5.0之后Android Runtime为ART</p>
<p>首先我们先了解一些文件的含义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">（<span class="number">1</span>）dex文件：Android将所有的class文件打包形成一个dex文件，是Dalvik运行的程序</span><br><span class="line">（<span class="number">2</span>）odex文件：优化过的dex文件，Apk在安装时会进行验证和优化，通过dexopt生成odex文件，加快Apk的响应时间</span><br><span class="line">（<span class="number">3</span>）oat文件：Android私有ELF文件格式，有dex2oat处理生成，包含（原dex文件+dex翻译的本地机器指令），是ART虚拟机使用的文件，可以直接加载</span><br><span class="line">（<span class="number">4</span>）vdex文件：Android <span class="number">8.0</span>引入，包含APK的未压缩DEX代码，以及一些旨在加快验证速度的元数据</span><br></pre></td></tr></table></figure>

<p>下面我们从Android系统的发展过程中详细介绍二者的区别：</p>
<table>
<thead>
<tr>
<th>版本</th>
<th>虚拟机类型</th>
<th>特性</th>
</tr>
</thead>
<tbody><tr>
<td>2.1-4.4</td>
<td>Dalvik</td>
<td>JIT+解释器</td>
</tr>
<tr>
<td>5.0-7.0</td>
<td>ART</td>
<td>AOT</td>
</tr>
<tr>
<td>7.0-11</td>
<td>ART</td>
<td>AOT+JIT+解释器</td>
</tr>
</tbody></table>
<p>下面部分参考博客：<a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903748058218509">博客地址</a></p>
<p><strong>Android 2.2</strong></p>
<p><strong>Dalvik</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">支持已转换成dex格式的android应用，基于寄存器，指令执行更快，加载的是odex文件，采用JIT运行时编译</span><br></pre></td></tr></table></figure>

<p><strong>JIT:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">	JIT即运行时编译策略，可以理解成一种运行时编译器，此时Android的虚拟机使用的是Dalvik，为了加快Dalvik虚拟机解释dex速度，运行时动态地将执行频率很高的dex字节码翻译成本地机器码</span><br><span class="line">缺点：</span><br><span class="line">	（1）每次启动应用都需要重新编译</span><br><span class="line">	（2）运行时比较耗电，造成电池额外的开销</span><br></pre></td></tr></table></figure>

<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/2.png" alt="image-20211002145934512"></p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/4.png" alt="image-20211003100041210"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">	基于Dalvik的虚拟机，在APK安装时会对dex文件进行优化，产生odex文件，然后在启动APP后，运行时会利用JIT即时编译，处理执行频率高的一部分dex，将其翻译成机器码，这样在再次调用的时候就可以直接运行机器码，从而提高了Dalvik翻译的速率，提高运行速度</span><br><span class="line">缺点：</span><br><span class="line">	（1）由于在Dex加载时会触发dexopt , 导致Multidex加载的时候会非常慢</span><br><span class="line">	（2）由于热点代码的Monitor一直在运行 , 解释器解释的字节码会带来CPU和时间的消耗, 会带来电量的损耗</span><br></pre></td></tr></table></figure>

<p><strong>Android 4.4——ART和AOT</strong></p>
<p>此时引入全新的虚拟机运行环境ART和全新的编译策略AOT，此时ART和Dalvik是共存的，用户可以在两者之间选择</p>
<p><strong>Android 5.0——ART全面取代Dalvik</strong></p>
<p>AOT:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">AOT是一种运行前编译的策略</span><br><span class="line">缺点：</span><br><span class="line">（<span class="number">1</span>）应用安装和系统升级之后的应用优化比较耗时</span><br><span class="line">（<span class="number">2</span>）优化后的文件会占用额外的存储空间</span><br></pre></td></tr></table></figure>

<p>AOT与JIT区别：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">JIT 是在运行时进行编译，是动态编译，并且每次运行程序的时候都需要对 odex 重新进行编译</span><br><span class="line">AOT 是静态编译，应用在安装的时候会启动 dex2oat 过程把 dex 预编译成 ELF 文件，每次运行程序的时候不用重新编译，是真正意义上的本地应用</span><br></pre></td></tr></table></figure>

<p>JVM、Dalvik和ART区别：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">JVM：传统的Java虚拟机、基于栈、运行class文件</span><br><span class="line">Dalvik:支持已转换成dex格式的android应用，基于寄存器，指令执行更快,加载的是odex（优化的dex）</span><br><span class="line">ART:第一次安装时，将dex进行Aot(预编译)，字节码预先编译成机器码，生成可执行oat文件（ELF文件）</span><br></pre></td></tr></table></figure>

<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/3.png" alt="image-20211002154534641"></p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/5.png" alt="image-20211003101124310"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">	基于ART的虚拟机，会在APK第一次安装时，将dex进行AOT(预编译)，通过dex2oat生成oat文件，即Android可执行ELF文件，包括原dex文件和翻译后的机器码，然后启动程序后，直接运行</span><br><span class="line">缺点：</span><br><span class="line">    （<span class="number">1</span>）由于安装APK时触发dex2oat , 需要编译成<span class="keyword">native</span> code , 导致安装时间过长</span><br><span class="line">    （<span class="number">2</span>）由于dex2oat生成的文件较大 , 会占用较多的空间</span><br></pre></td></tr></table></figure>

<p><strong>Android 7.0——JIT回归</strong></p>
<p>考虑上面AOT的缺点，dex2oat过程比较耗时且会占用额外的存储空间，Android 7.0 再次加入JIT形成<code>AOT+JIT+解释器</code>模式</p>
<p>特点：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">（1）应用在安装的时候 dex 不会被编译</span><br><span class="line">（2）应用在运行时 dex 文件先通过解析器（Interpreter）后会被直接执行，与此同时，热点函数（Hot Code）会被识别并被 JIT 编译后存储在 jit code cache 中并生成 profile 文件以记录热点函数的信息</span><br><span class="line">（3）手机进入 IDLE（空闲） 或者 Charging（充电） 状态的时候，系统会扫描 App 目录下的 profile 文件并执行 AOT 过程进行编译</span><br></pre></td></tr></table></figure>

<p>混合编译模式综合了 AOT 和 JIT 的各种优点，使得应用在安装速度加快的同时，运行速度、存储空间和耗电量等指标都得到了优化</p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/6.png" alt="image-20211003102555392"></p>
<p>最后我们可以看下Android各版本ClassLoader加载dex时的dexopt过程：</p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/7.png" alt="image-20211003102844820"></p>
<h4 id="（4）原生C-x2F-C-库"><a href="#（4）原生C-x2F-C-库" class="headerlink" title="（4）原生C&#x2F;C++库"></a>（4）原生C&#x2F;C++库</h4><p>许多核心 Android 系统组件和服务（例如 ART 和 HAL）构建自原生代码，需要以 C 和 C++ 编写的原生库。Android 平台提供 Java 框架 API 以向应用显示其中部分原生库的功能，我们可以通过NDK开发Android中的C&#x2F;C++库</p>
<h4 id="（5）Java-API框架"><a href="#（5）Java-API框架" class="headerlink" title="（5）Java API框架"></a>（5）Java API框架</h4><p>通过以 Java 语言编写的 API 使用 Android OS 的整个功能集。这些 API 形成创建 Android 应用所需的构建块，它们可简化核心模块化系统组件和服务的重复使用，包括以下组件和服务</p>
<h3 id="2-Android启动流程"><a href="#2-Android启动流程" class="headerlink" title="2. Android启动流程"></a>2. Android启动流程</h3><p>Android启动流程如下图所示：</p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/8.png" alt="image-20211003102844820"></p>
<h4 id="（1）Loader"><a href="#（1）Loader" class="headerlink" title="（1）Loader"></a>（1）Loader</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Boot ROM: 当手机处于关机状态时，长按Power键开机，引导芯片开始从固化在ROM里的预设代码开始执行，然后加载引导程序到RAM</span><br><span class="line">Boot Loader：这是启动Android系统之前的引导程序，主要是检查RAM，初始化硬件参数，拉起Android OS</span><br></pre></td></tr></table></figure>

<p>我们长按电源键后，手机就会在Loader层加载引导程序，并启动引导程序，初始化参数</p>
<h4 id="（2）Linux内核"><a href="#（2）Linux内核" class="headerlink" title="（2）Linux内核"></a>（2）Linux内核</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">1</span>)启动Kernel的swapper进程(pid=<span class="number">0</span>)：该进程又称为idle进程, 系统初始化过程Kernel由无到有开创的第一个进程, 用于初始化进程管理、内存管理，加载Display,Camera Driver，Binder Driver等相关工作，这些模块驱动都会封装到对应的HAL层中</span><br><span class="line">(<span class="number">2</span>)启动 init 进程（用户进程的祖宗）。pid = <span class="number">1</span>，用来孵化用户空间的守护进程、HAL、开机动画等</span><br><span class="line">(<span class="number">3</span>)启动kthreadd进程（pid=<span class="number">2</span>）：是Linux系统的内核进程，会创建内核工作线程kworkder，软中断线程ksoftirqd，thermal等内核守护进程。kthreadd进程是所有内核进程的鼻祖	</span><br></pre></td></tr></table></figure>

<h4 id="（3）执行init进程"><a href="#（3）执行init进程" class="headerlink" title="（3）执行init进程"></a>（3）执行init进程</h4><p>init 进程是Linux系统中用户空间的第一个进程，进程号为1，是所以用户进程的祖先</p>
<p>Linux Kernel完成系统设置后，会首先在系统中寻找init.rc文件，并启动init进程，init.rc脚本存放路径：<code> /system/core/rootdir/init.rc</code> ，init进程：<code>/system/core/init </code></p>
<p>init进程的启动可以分为三个部分：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">（<span class="number">1</span>）init进程会孵化出ueventd、logd、healthd、installd、adbd、lm这里写代码片kd等用户守护进程</span><br><span class="line">（<span class="number">2</span>）init进程还会启动ServiceManager(Binder服务管家)、bootanim(开机动画)等重要服务</span><br><span class="line">（<span class="number">3</span>）解析init.rc配置文件并孵化zygote进程,Zygote进程是Android系统的第一个java进程（虚拟机进程），zygote进程是所以Java进程的父进程</span><br></pre></td></tr></table></figure>

<p>创建Zygote过程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">（<span class="number">1</span>）解析 init.zygote.rc <span class="comment">//parse_service() </span></span><br><span class="line">（<span class="number">2</span>）启动 main 类型服务 <span class="comment">//do_class_start() </span></span><br><span class="line">（<span class="number">3</span>）启动 zygote 服务 <span class="comment">//service_start() </span></span><br><span class="line">（<span class="number">4</span>）创建 Zygote 进程 <span class="comment">//fork() </span></span><br><span class="line">（<span class="number">5</span>）创建 Zygote Socket <span class="comment">//create_socket()</span></span><br></pre></td></tr></table></figure>

<h4 id="（4）Zygote"><a href="#（4）Zygote" class="headerlink" title="（4）Zygote"></a>（4）Zygote</h4><p>Zygote为孵化器，即所有Android应用的祖先，Zygote 让 VM 共享代码、低内存占用以及最小的启动时间成为可能， Zygote 是一个虚拟机进程，Zygote是由init进程通过解析<code>init.zygote.rc</code>文件而创建的，zygote所对应的可执行程序<code>app_process</code>，所对应的源文件是<code>App_main.cpp</code>，进程名为zygote</p>
<p>Zygote作用过程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">1</span>)解析init.zygote.rc中的参数，创建AppRuntime并调用AppRuntime.start()方法；</span><br><span class="line">(<span class="number">2</span>)调用AndroidRuntime的startVM()方法创建虚拟机，再调用startReg()注册JNI函数；</span><br><span class="line">(<span class="number">3</span>)通过JNI方式调用ZygoteInit.main()，第一次进入Java世界；</span><br><span class="line">(<span class="number">4</span>)registerZygoteSocket()建立socket通道，zygote作为通信的服务端，用于响应客户端请求；</span><br><span class="line">(<span class="number">5</span>)preload()预加载通用类、drawable和color资源、openGL以及共享库以及WebView，用于提高app启动效率；</span><br><span class="line">(<span class="number">6</span>)zygote完毕大部分工作，接下来再通过startSystemServer()，fork得力帮手system_server进程，也是上层framework的运行载体。</span><br><span class="line">(<span class="number">7</span>)zygote功成身退，调用runSelectLoop()（死循环），随时待命，当接收到请求创建新进程请求时立即唤醒并执行相应工作。</span><br></pre></td></tr></table></figure>

<p>Android系统流程总结：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">1</span>) 手机开机后，引导芯片启动，引导芯片开始从固化在ROM里的预设代码执行，加载引导程序到到RAM，BootLoader检查RAM，初始化硬件参数等功能；</span><br><span class="line">(<span class="number">2</span>) 硬件等参数初始化完成后，进入到Kernel层，Kernel层主要加载一些硬件设备驱动，初始化进程管理等操作。在Kernel中首先启动swapper进程（pid=<span class="number">0</span>），用于初始化进程管理、内管管理、加载Driver等操作，再启动kthread进程(pid=<span class="number">2</span>),这些linux系统的内核进程，kthread是所有内核进程的鼻祖；</span><br><span class="line">(<span class="number">3</span>) Kernel层加载完毕后，硬件设备驱动与HAL层进行交互。初始化进程管理等操作会启动init进程 ，这些在Native层中；</span><br><span class="line">(<span class="number">4</span>) init进程(pid=<span class="number">1</span>，init进程是所有进程的鼻祖，第一个启动)启动后，会启动adbd，logd等用户守护进程，并且会启动servicemanager(binder服务管家)等重要服务，同时孵化出zygote进程，这里属于C++ Framework，代码为C++程序；</span><br><span class="line">(<span class="number">5</span>) zygote进程是由init进程解析init.rc文件后fork生成，它会加载虚拟机，启动System <span class="title function_">Server</span><span class="params">(zygote孵化的第一个进程)</span>；SystemServer负责启动和管理整个Java Framework，包含ActivityManager，WindowManager，PackageManager，PowerManager等服务；</span><br><span class="line">(<span class="number">6</span>) zygote同时会启动相关的APP进程，它启动的第一个APP进程为Launcher，然后启动Email，SMS等进程，所有的APP进程都有zygote fork生成。</span><br></pre></td></tr></table></figure>

<h2 id="三、Xposed框架运行机制"><a href="#三、Xposed框架运行机制" class="headerlink" title="三、Xposed框架运行机制"></a>三、Xposed框架运行机制</h2><p>我们从上文中已经详细介绍了Android的启动流程，如下图所示：</p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/9.png" alt="image-20211003102844820"></p>
<p>下面我们来详细介绍Xposed框架的实现原理：</p>
<h3 id="1-Xposed实现原理"><a href="#1-Xposed实现原理" class="headerlink" title="1.  Xposed实现原理"></a>1.  Xposed实现原理</h3><p>我们先进入<a target="_blank" rel="noopener" href="https://github.com/rovo89">Xposed官网</a>，可以发现Xposed工程的5个文件夹：</p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/10.png" alt="image-20211003120209903"></p>
<p>具体的模块功能和作用，我们在上文<a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-269616.htm">源码编译（2）——Xopsed源码编译详解</a>已经介绍了，大家可以去参考</p>
<p>上文中我们知道，Xposed集成到Android源码中主要是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">（1）替换了Android中的虚拟机art</span><br><span class="line">（2）替换了app_process以及生成的一些lib，bin文件等</span><br></pre></td></tr></table></figure>

<p>具体如下图所示</p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/11.png" alt="image-20211003120719433"></p>
<p>我们从上文中可以得知Android所有的用户进程都是通过Zygote孵化出来的，而Zygote的执行程序是app_process，安装Xposed，将app_process替换，然后替换对应的虚拟机，这样Zygote孵化器就变成了Xposed孵化器</p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/12.png" alt="image-20211003134604388"></p>
<p>我们先来分析一下替换后的<code>app_process</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ifeq (<span class="number">1</span>,$(strip $(shell expr $(PLATFORM_SDK_VERSION) \&gt;= <span class="number">21</span>)))</span><br><span class="line">  LOCAL_SRC_FILES := app_main2.cpp</span><br><span class="line">  LOCAL_MULTILIB := both</span><br><span class="line">  LOCAL_MODULE_STEM_32 := app_process32_xposed</span><br><span class="line">  LOCAL_MODULE_STEM_64 := app_process64_xposed</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  LOCAL_SRC_FILES := app_main.cpp</span><br><span class="line">  LOCAL_MODULE_STEM := app_process_xposed</span><br><span class="line">endif</span><br><span class="line">...</span><br><span class="line">ifeq (<span class="number">1</span>,$(strip $(shell expr $(PLATFORM_SDK_VERSION) \&gt;= <span class="number">21</span>)))</span><br><span class="line">  include frameworks/base/cmds/xposed/ART.mk</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  include frameworks/base/cmds/xposed/Dalvik.mk</span><br><span class="line">endif</span><br></pre></td></tr></table></figure>

<p>程序通过判断<code>SDK</code>的版本选择加载文件，这里我们是在Android 6.0上运行，SDK版本为23，因此<code>app_process</code>会执行<code>app_main2.cpp</code>和<code>ART.mk</code></p>
<p>为了方便我们分析，这里我画了一个思维导图方便大家结合后面源码分析：</p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/18.png" alt="image-20211003145325591"></p>
<p>我们再分析app_main2.cpp中main函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* <span class="type">const</span> argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (xposed::handleOptions(argc, argv))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//代码省略...</span></span><br><span class="line">    runtime.mParentDir = parentDir;</span><br><span class="line">    <span class="comment">// 初始化xposed，主要是将jar包添加至Classpath中</span></span><br><span class="line">    isXposedLoaded = xposed::initialize(zygote, startSystemServer, className, argc, argv);</span><br><span class="line">    <span class="keyword">if</span> (zygote) &#123;</span><br><span class="line">        <span class="comment">// 如果xposed初始化成功，将zygoteInit 替换为 de.robv.android.xposed.XposedBridge，然后创建虚拟机</span></span><br><span class="line">        runtime.start(isXposedLoaded ? XPOSED_CLASS_DOTS_ZYGOTE : <span class="string">&quot;com.android.internal.os.ZygoteInit&quot;</span>,</span><br><span class="line">                startSystemServer ? <span class="string">&quot;start-system-server&quot;</span> : <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">main函数主要做了两件事：</span><br><span class="line">(<span class="number">1</span>)初始化xposed</span><br><span class="line">(<span class="number">2</span>)创建虚拟机</span><br></pre></td></tr></table></figure>

<p><strong>初始化xposed：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">bool <span class="title function_">initialize</span><span class="params">(bool zygote, bool startSystemServer, const <span class="type">char</span>* className, <span class="type">int</span> argc, <span class="type">char</span>* const argv[])</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 初始化xposed的相关变量</span></span><br><span class="line">    xposed-&gt;zygote = zygote;</span><br><span class="line">    xposed-&gt;startSystemServer = startSystemServer;</span><br><span class="line">    xposed-&gt;startClassName = className;</span><br><span class="line">    xposed-&gt;xposedVersionInt = xposedVersionInt;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 打印 release、sdk、manufacturer、model、rom、fingerprint、platform相关数据</span></span><br><span class="line">    printRomInfo();</span><br><span class="line">    <span class="comment">// 主要在于将jar包加入Classpath</span></span><br><span class="line">    <span class="keyword">return</span> addJarToClasspath();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">（<span class="number">1</span>）初始化xposed内相关变量</span><br><span class="line">（<span class="number">2</span>）调用addJarToClasspath将XposedBridge.jar添加至系统目录</span><br></pre></td></tr></table></figure>

<p><strong>创建虚拟机：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> AndroidRuntime::start(const <span class="type">char</span>* className, const Vector&lt;String8&gt;&amp; options)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* start the virtual machine */</span></span><br><span class="line">    JniInvocation jni_invocation;</span><br><span class="line">    jni_invocation.Init(NULL);</span><br><span class="line">    JNIEnv* env;</span><br><span class="line">    <span class="comment">//创建虚拟机</span></span><br><span class="line">    <span class="keyword">if</span> (startVm(&amp;mJavaVM, &amp;env) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 初始化虚拟机，xposed对虚拟机进行修改</span></span><br><span class="line">    onVmCreated(env);</span><br><span class="line">    <span class="comment">// 虚拟机初始化完成后，会调用传入的de.robv.android.xposed.XposedBridge类，初始化java层XposedBridge.jar</span></span><br><span class="line">    <span class="type">char</span>* slashClassName = toSlashClassName(className);</span><br><span class="line">    <span class="type">jclass</span> <span class="variable">startClass</span> <span class="operator">=</span> env-&gt;FindClass(slashClassName);</span><br><span class="line">    <span class="keyword">if</span> (startClass == NULL) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">jmethodID</span> <span class="variable">startMeth</span> <span class="operator">=</span> env-&gt;GetStaticMethodID(startClass, <span class="string">&quot;main&quot;</span>,</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">（<span class="number">1</span>）创建虚拟机</span><br><span class="line">（<span class="number">2</span>）初始化虚拟机xposed对虚拟机进行修改, onVmCreated(env)</span><br><span class="line">（<span class="number">3</span>）传入调用类de.robv.android.xposed.XposedBridge</span><br><span class="line">（<span class="number">4</span>）初始化XposedBridge</span><br></pre></td></tr></table></figure>

<p>这里我们可以参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/luoshengyang/article/details/8885792">老罗的源码分析</a>:</p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/13.png" alt="image-20211003140514072"></p>
<p>我们可以发现，我们在初始化虚拟机后，xposed会对虚拟机修改，函数<code>onVmCreated(env)</code></p>
<p><strong>onVmCreated(env):</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">onVmCreated</span><span class="params">(JNIEnv* env)</span> &#123;</span><br><span class="line">    <span class="comment">// Determine the currently active runtime</span></span><br><span class="line">    <span class="keyword">if</span> (!determineRuntime(&amp;xposedLibPath)) </span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Load the suitable libxposed_*.so for it 通过dlopen加载libxposed_art.so</span></span><br><span class="line">    <span class="keyword">void</span>* xposedLibHandle = dlopen(xposedLibPath, RTLD_NOW);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Initialize the library  初始化xposed相关库</span></span><br><span class="line">    bool (*xposedInitLib)(XposedShared* shared) = NULL;</span><br><span class="line">    *(<span class="keyword">void</span> **) (&amp;xposedInitLib) = dlsym(xposedLibHandle, <span class="string">&quot;xposedInitLib&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!xposedInitLib)  &#123;</span><br><span class="line">        ALOGE(<span class="string">&quot;Could not find function xposedInitLib&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// xposedInitLib -&gt; onVmCreatedCommon -&gt; initXposedBridge -&gt; 注册Xposed相关Native方法</span></span><br><span class="line">    <span class="keyword">if</span> (xposedInitLib(xposed)) &#123;</span><br><span class="line">        xposed-&gt;onVmCreated(env);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们来分析<code>xposedInitLib</code></p>
<p>libxposed_art.cpp#xposedInitLib</p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/14.png" alt="image-20211003142331938"></p>
<p>libxposed_common.cpp#onVmCreatedCommon</p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/15.png" alt="image-20211003142641730"></p>
<p>libxposed_common.cpp#initXposedBridge</p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/16.png" alt="image-20211003143129911"></p>
<p><strong>libxposed_art.cpp#onVmCreated</strong></p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/17.png" alt="image-20211003143243869"></p>
<p>onVmCreated总结：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">（<span class="number">1</span>）通过dlopen加载libxposed_art.so</span><br><span class="line">（<span class="number">2</span>）初始化xposed相关库 xposedInitLib</span><br><span class="line">（<span class="number">3</span>）xposedInitLib-&gt;onVmCreatedCommon-&gt;initXposedBridge，初始化XposedBridge，将register_natives_XposedBridge中的函数注册为Native方法</span><br><span class="line">（<span class="number">4</span>）xposedInitLib-&gt;onVmCreatedCommon-&gt;onVmCreated，为xposed_callback_class与xposed_callback_method赋值</span><br></pre></td></tr></table></figure>

<p><strong>de.robv.android.xposed.XposedBridge#main</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// Initialize the Xposed framework and modules</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!hadInitErrors()) &#123;</span><br><span class="line">                initXResources();</span><br><span class="line">                SELinuxHelper.initOnce();</span><br><span class="line">                SELinuxHelper.initForProcess(<span class="literal">null</span>);</span><br><span class="line">                runtime = getRuntime();</span><br><span class="line">                XPOSED_BRIDGE_VERSION = getXposedVersion();</span><br><span class="line">                <span class="keyword">if</span> (isZygote) &#123;</span><br><span class="line">                    XposedInit.hookResources();</span><br><span class="line">                    XposedInit.initForZygote();</span><br><span class="line">                &#125;</span><br><span class="line">                XposedInit.loadModules();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Log.e(TAG, <span class="string">&quot;Not initializing Xposed because of previous errors&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="comment">// Call the original startup code</span></span><br><span class="line">        <span class="keyword">if</span> (isZygote) &#123;</span><br><span class="line">            ZygoteInit.main(args);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            RuntimeInit.main(args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>源码分析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">虚拟机初始化完成后，会调用传入的de.robv.android.xposed.XposedBridge类，初始化java层XposedBridge.jar，调用main函数</span><br><span class="line">（<span class="number">1</span>）hook 系统资源相关的方法   XposedInit.hookResources()</span><br><span class="line">（<span class="number">2</span>）hook zygote 的相关方法   XposedInit.initForZygote()</span><br><span class="line">（<span class="number">3</span>）加载系统中已经安装的xposed 模块   XposedInit.loadModules()</span><br></pre></td></tr></table></figure>

<p>到此Xposed初始化结束</p>
<h3 id="2-Xposed-hook原理"><a href="#2-Xposed-hook原理" class="headerlink" title="2. Xposed hook原理"></a>2. Xposed hook原理</h3><p>通过上文的详细分析，我们可以得出Xposed的hook原理：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Xposed的基本原理是修改了ART/Davilk虚拟机，将需要hook的函数注册为Native层函数。当执行到这一函数是虚拟机会优先执行Native层函数，然后再去执行Java层函数，这样完成函数的hook</span><br></pre></td></tr></table></figure>

<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/19.png" alt="image-20211003145926728"></p>
<p>启动过程总结：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">（<span class="number">1</span>）手机启动时init进程会启动zygote这个进程。由于zygote进程文件app_process已被替换，所以启动的时Xposed版的zygote进程</span><br><span class="line">（<span class="number">2</span>）Xposed_zygote进程启动后会初始化一些so文件（system/lib system/lib64），然后进入XposedBridge.jar中的XposedBridge.main中初始化jar包完成对一些关键Android系统函数的hook</span><br><span class="line">（<span class="number">3</span>）Hook则是利用修改过的虚拟机将函数注册为<span class="keyword">native</span>函数</span><br><span class="line">（<span class="number">4</span>）然后再返回zygote中完成原本zygote需要做的工作</span><br></pre></td></tr></table></figure>

<p>我们对Xposed的基本原理和hook原理就基本掌握了，大家都知道我们这使用Xposed时，需要不断的去重启手机和勾选我们安装的模块，为了方便使用，这里补充两个技巧，我们了解Xposed源码后，就可以很方便实现了</p>
<h4 id="（1）取消重启手机"><a href="#（1）取消重启手机" class="headerlink" title="（1）取消重启手机"></a>（1）取消重启手机</h4><p>我们先观察上文XposedBridge中main</p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/20.png" alt="image-20211003150826842"></p>
<p>上面的XposedInit.loadModules()这个函数，这个函数的作用就是load hook模块到进程中，因为zygote启动时先跑到java层XposeBridge.main中，在main里面有一步操作是将hook模块load进来，模块加载到zygote进程中，zygote fork所有的app进程里面也有这个hook模块，所以这个模块可以hook任意app。</p>
<p>编写hook模块的第一步就是判断当前的进程名字，如果是要hook的进程就hook，不是则返回，所以修改模块后，要将模块重新load zygote里面必须重启zygote，要想zygote重启就要重启手机了。</p>
<p>解决办法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">所以修改的逻辑是不把模块load到zygote里面，而是load到自己想要hook的进程里面，这样修改模块后只需重启该进程即可</span><br></pre></td></tr></table></figure>

<p>步骤：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">（1）将上面XposedInit.loadModules()注释掉即可</span><br><span class="line">（2）在2处修改代码</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (isZygote) &#123;</span><br><span class="line">      XposedHelpers.findAndHookMethod(<span class="string">&quot;com.android.internal.os.ZygoteConnection&quot;</span>, BOOTCLASSLOADER, <span class="string">&quot;handleChildProc&quot;</span>,</span><br><span class="line">              <span class="string">&quot;com.android.internal.os.ZygoteConnection.Arguments&quot;</span>,FileDescriptor[].class,FileDescriptor.class,</span><br><span class="line">              PrintStream.class,<span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line"></span><br><span class="line">                  <span class="meta">@Override</span></span><br><span class="line">                  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                      <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">                      <span class="built_in">super</span>.afterHookedMethod(param);</span><br><span class="line">                      <span class="type">String</span> <span class="variable">processName</span> <span class="operator">=</span> (String) XposedHelpers.getObjectField(param.args[<span class="number">0</span>], <span class="string">&quot;niceName&quot;</span>);</span><br><span class="line">                      <span class="type">String</span> <span class="variable">coperationAppName</span> <span class="operator">=</span> <span class="string">&quot;指定进程名称如：com.android.settings&quot;</span>;</span><br><span class="line">                      <span class="keyword">if</span>(processName != <span class="literal">null</span>)&#123;</span><br><span class="line">                          <span class="keyword">if</span>(processName.startsWith(coperationAppName))&#123;</span><br><span class="line">                              log(<span class="string">&quot;--------Begin Load Module-------&quot;</span>);</span><br><span class="line">                              XposedInit.loadModules();</span><br><span class="line">                          &#125;</span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125;</span><br><span class="line"></span><br><span class="line">              &#125;);</span><br><span class="line">      ZygoteInit.main(args);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      RuntimeInit.main(args);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>我们只需要将我们的模块进程指定，这样就不用每次开机都重启那</p>
<h4 id="（2）取消操作Installer-APP"><a href="#（2）取消操作Installer-APP" class="headerlink" title="（2）取消操作Installer APP"></a>（2）取消操作Installer APP</h4><p>通过阅读源码，我们发现读Install App的源码发现其实勾选hook模块其实app就是把模块的apk位置写到一个文件里，等load模块时会读取这个文件，从这个文件中的apk路径下把apk load到进程中</p>
<p><strong>loadmodules的源码：</strong></p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/21.png" alt="image-20211003152312993"></p>
<p>apk配置文件就是installer app文件路径下的<code>conf/modules.list</code>这个文件<code>data/data/de.robv.android.xposed.installer/conf/modules.list</code><br> 或者<code>data/user_de/0/de.robv.android.xposed.installer/conf/modules.list</code></p>
<p>所以我们勾选一个文件，实际是将其写到<code>conf/modules.list</code>文件下，此时我们发现Xposed中还有一个方法<code>loadModule</code></p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/22.png" alt="image-20211003152549464"></p>
<p>这个方法可以根据具体的路径和类加载器，直接导入模块，所以只要我们在上面代码中修改一些，就可以直接导入，不需要勾选那，我们确定apk路径:<code>pathclass = &quot;/data/local/tmp/module.apk&quot;</code>和类加载器为根类加载器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (isZygote) &#123;</span><br><span class="line">         XposedHelpers.findAndHookMethod(<span class="string">&quot;com.android.internal.os.ZygoteConnection&quot;</span>, BOOTCLASSLOADER, <span class="string">&quot;handleChildProc&quot;</span>,</span><br><span class="line">                 <span class="string">&quot;com.android.internal.os.ZygoteConnection.Arguments&quot;</span>,FileDescriptor[].class,FileDescriptor.class,</span><br><span class="line">                 PrintStream.class,<span class="keyword">new</span> <span class="title class_">XC_MethodHook</span>() &#123;</span><br><span class="line"></span><br><span class="line">                     <span class="meta">@Override</span></span><br><span class="line">                     <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                         <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">                         <span class="built_in">super</span>.afterHookedMethod(param);</span><br><span class="line">                         <span class="type">String</span> <span class="variable">processName</span> <span class="operator">=</span> (String) XposedHelpers.getObjectField(param.args[<span class="number">0</span>], <span class="string">&quot;niceName&quot;</span>);</span><br><span class="line">                         <span class="type">String</span> <span class="variable">coperationAppName</span> <span class="operator">=</span> <span class="string">&quot;指定进程名称如：com.android.settings&quot;</span>;</span><br><span class="line">                         <span class="keyword">if</span>(processName != <span class="literal">null</span>)&#123;</span><br><span class="line">                             <span class="keyword">if</span>(processName.startsWith(coperationAppName))&#123;</span><br><span class="line">                                 log(<span class="string">&quot;--------Begin Load Module-------&quot;</span>);</span><br><span class="line">                                 <span class="type">String</span> <span class="variable">pathclass</span> <span class="operator">=</span> <span class="string">&quot;/data/local/tmp/module.apk&quot;</span>;</span><br><span class="line">                                 <span class="comment">//注意这里是loadModule方法,类加载器是我们的根类加载器</span></span><br><span class="line">                                 XposedInit.loadModule(pathclass,BOOTCLASSLOADER);</span><br><span class="line">                             &#125;</span><br><span class="line">                         &#125;</span><br><span class="line">                     &#125;</span><br><span class="line"></span><br><span class="line">                 &#125;);</span><br><span class="line">         ZygoteInit.main(args);</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         RuntimeInit.main(args);</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<h2 id="四、Xposed框架特征"><a href="#四、Xposed框架特征" class="headerlink" title="四、Xposed框架特征"></a>四、Xposed框架特征</h2><p>本节参考世界美景大佬<a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-255836.htm">定制Xposed框架</a>和肉丝大佬<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/YAMCrQSi0LFJGNIwB9qHDA">来自高纬的对抗：魔改XPOSED过框架检测(下)</a>，经过我们上文的Android运行机制和Xposed框架运行机制讲解，相信大家对Xposed的框架已经有了进一步的认识，这样我们再来看这篇帖子里的修改的特征，就显得十分清晰了</p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/23.png" alt="image-20211003152549464"></p>
<h2 id="五、Xposed特征修改"><a href="#五、Xposed特征修改" class="headerlink" title="五、Xposed特征修改"></a>五、Xposed特征修改</h2><h3 id="1-XposedInstaller"><a href="#1-XposedInstaller" class="headerlink" title="1. XposedInstaller"></a>1. XposedInstaller</h3><p>我们下载XposedInstaller的工程代码加载到AndroidStudio中，让XposedInstaller配置环境，错误提示解决见上文<a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-269616.htm">源码编译（2）——Xopsed源码编译详解</a></p>
<p>修改点：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">（1）修改整体包名</span><br><span class="line">（2）修改xposed.prop</span><br></pre></td></tr></table></figure>

<h4 id="（1）修改整体包名"><a href="#（1）修改整体包名" class="headerlink" title="（1）修改整体包名"></a>（1）修改整体包名</h4><p>先来改下整体的包名，首先将目录折叠给取消掉</p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/24.png" alt="image-20211003152549464"></p>
<p>然后我们在包名路径中，将xposed改成xppsed，这样可以保证包名长度是一样，同时xposed特征消失不见，选择Refactor→Rename</p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/25.png" alt="image-20211003152549464"></p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/26.png" alt="image-20211003152549464"></p>
<p>我们直接点击Refactor，就可以替换成功，点击Preview，则需要再点击 Do Refactor </p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/27.png" alt="image-20211003152549464"></p>
<p>这时候我们可以发现程序下的包名都改变了</p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/28.png" alt="image-20211003152549464"></p>
<p>接下来就是在整个项目的根文件夹下，进行整体的包名替换，因为还有很多编译配置、或者路径配置等等，需要进行包名的更换</p>
<p>在app文件夹右击，选择Replace in Path</p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/29.png" alt="image-20211003152549464"></p>
<p>把所有的<code>de.robv.android.xposed.installe</code>都改成<code>de.robv.android.xpsed.installer</code></p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/30.png" alt="image-20211003152549464"></p>
<p>搜出来匹配的地方只有5个文件中合计的7处地方，并不多，直接replace All替换即可</p>
<h4 id="（2）xposed-prop改成xpsed-prop"><a href="#（2）xposed-prop改成xpsed-prop" class="headerlink" title="（2）xposed.prop改成xpsed.prop"></a>（2）<code>xposed.prop</code>改成<code>xpsed.prop</code></h4><p>就是把如下图处的<code>xposed.prop</code>改成<code>xppsed.prop</code>即可</p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/31.png" alt="image-20211003152549464"></p>
<p>接下来就是编译了。编译时先Build→Clean一下，然后再Build→Make Project，这样就直接编译通过了。可以连接到手机，刷到手机上去，App会被装在手机上，但是无法自动启动，得手动点开</p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/59.png" alt="image-20211003174013862"></p>
<h3 id="2-XposedBridge"><a href="#2-XposedBridge" class="headerlink" title="2. XposedBridge"></a>2. XposedBridge</h3><h4 id="（1）修改整体包名-1"><a href="#（1）修改整体包名-1" class="headerlink" title="（1）修改整体包名"></a>（1）修改整体包名</h4><p>首先是改包名，方法与上文一模一样，也是首先将xposed进行重构，改成xppsed</p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/32.png" alt="image-20211003152549464"></p>
<p>注：我们发现很多类型需要手动修改包名，我们依次将包名修改，这里我们发现重构后没反应，很可能是Android Studio的问题，换一个版本或重启</p>
<p>然后也是一样的在项目根目录下，执行Replace in Path，将所有的<code>de.robv.android.xposed.installer</code>都改成<code>de.robv.android.xppsed.installer</code></p>
<p>这里就修改完成</p>
<h4 id="（2）生成文件"><a href="#（2）生成文件" class="headerlink" title="（2）生成文件"></a>（2）生成文件</h4><p><strong>XposedBridge.jar:</strong></p>
<p>先Make Clean一下，然后编译，将编译出来的文件复制一份，命名为XppsedBridge.jar即可</p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/33.png" alt="image-20211003152549464"></p>
<p><strong>api.jar:</strong></p>
<p>然后我们在Gradle-&gt;others-&gt;generate API中生成api.jar，保存在build&#x2F;api下</p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/34.png" alt="image-20211003152549464"></p>
<h3 id="3-Xposed"><a href="#3-Xposed" class="headerlink" title="3. Xposed"></a>3. Xposed</h3><p>Xposed中的文件需要修改的地方不少：</p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/35.png" alt="image-20211003152549464"></p>
<h4 id="（1）libxposed-common-h"><a href="#（1）libxposed-common-h" class="headerlink" title="（1）libxposed_common.h"></a>（1）libxposed_common.h</h4><p>修改之前：</p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/36.png" alt="image-20211003152549464"></p>
<p>修改之后：</p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/37.png" alt="image-20211003152549464"></p>
<h4 id="（2）Xposed-h"><a href="#（2）Xposed-h" class="headerlink" title="（2）Xposed.h"></a>（2）Xposed.h</h4><p>修改之前：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#define XPOSED_PROP_FILE <span class="string">&quot;/system/xposed.prop&quot;</span></span><br><span class="line">#define XPOSED_LIB_ART XPOSED_LIB_DIR <span class="string">&quot;libxposed_art.so&quot;</span></span><br><span class="line">#define XPOSED_JAR <span class="string">&quot;/system/framework/XposedBridge.jar&quot;</span></span><br><span class="line">#define XPOSED_CLASS_DOTS_ZYGOTE <span class="string">&quot;de.robv.android.xposed.XposedBridge&quot;</span></span><br><span class="line">#define XPOSED_CLASS_DOTS_TOOLS <span class="string">&quot;de.robv.android.xposed.XposedBridge$ToolEntryPoint&quot;</span></span><br></pre></td></tr></table></figure>

<p>修改之后：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#define XPOSED_PROP_FILE <span class="string">&quot;/system/xppsed.prop&quot;</span></span><br><span class="line">#define XPOSED_LIB_ART XPOSED_LIB_DIR <span class="string">&quot;libxppsed_art.so&quot;</span></span><br><span class="line">#define XPOSED_JAR <span class="string">&quot;/system/framework/XppsedBridge.jar“</span></span><br><span class="line"><span class="string">#define XPOSED_CLASS_DOTS_ZYGOTE &quot;</span>de.robv.android.xppsed.XposedBridge<span class="string">&quot;</span></span><br><span class="line"><span class="string">#define XPOSED_CLASS_DOTS_TOOLS &quot;</span>de.robv.android.xppsed.XposedBridge$ToolEntryPoint<span class="string">&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/38.png" alt="image-20211003152549464"></p>
<h4 id="（3）xposed-service-cpp"><a href="#（3）xposed-service-cpp" class="headerlink" title="（3）xposed_service.cpp"></a>（3）xposed_service.cpp</h4><p>修改之前：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IMPLEMENT_META_INTERFACE(XposedService, <span class="string">&quot;de.robv.android.xposed.IXposedService&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>修改之后：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IMPLEMENT_META_INTERFACE(XposedService, <span class="string">&quot;de.robv.android.xppsed.IXposedService&quot;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="（4）xposed-shared-h"><a href="#（4）xposed-shared-h" class="headerlink" title="（4）xposed_shared.h"></a>（4）xposed_shared.h</h4><p>修改之前：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#define XPOSED_DIR <span class="string">&quot;/data/user_de/0/de.robv.android.xposed.installer/&quot;</span></span><br><span class="line">#define XPOSED_DIR <span class="string">&quot;/data/data/de.robv.android.xposed.installer/&quot;</span></span><br></pre></td></tr></table></figure>

<p>修改之后：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#define XPOSED_DIR <span class="string">&quot;/data/user_de/0/de.robv.android.xppsed.installer/&quot;</span></span><br><span class="line">#define XPOSED_DIR <span class="string">&quot;/data/data/de.robv.android.xppsed.installer/&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/39.png" alt="image-20211003152549464"></p>
<h4 id="（5）ART-mk"><a href="#（5）ART-mk" class="headerlink" title="（5）ART.mk"></a>（5）ART.mk</h4><p>修改之前：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">libxposed_art.cpp</span><br><span class="line">LOCAL_MODULE := libxposed_art</span><br></pre></td></tr></table></figure>

<p>修改之后：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">libxppsed_art.cpp</span><br><span class="line">LOCAL_MODULE := libxppsed_art</span><br></pre></td></tr></table></figure>

<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/40.png" alt="image-20211003152549464"></p>
<h4 id="（6）libxposed-art-cpp"><a href="#（6）libxposed-art-cpp" class="headerlink" title="（6）libxposed_art.cpp"></a>（6）libxposed_art.cpp</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">将文件夹下的libxposed_art.cpp文件，重命名为libxppsed_art.cpp</span><br></pre></td></tr></table></figure>

<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/41.png" alt="image-20211003152549464"></p>
<h3 id="4-XposedTools"><a href="#4-XposedTools" class="headerlink" title="4. XposedTools"></a>4. XposedTools</h3><p>我们在XposedTools中将<code>build.pl</code>和<code>zipstatic/_all/META-INF/com/google/android/flash-script.sh</code>的字符替换就可以了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">xposed.prop---&gt;xppsed.prop</span><br><span class="line">XposedBridge.jar---&gt;XppsedBridge.jar</span><br><span class="line">libxposed_art---&gt;libxppsed_art</span><br></pre></td></tr></table></figure>

<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/42.png" alt="image-20211003152549464"></p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/43.png" alt="image-20211003152549464"></p>
<p>记得不要有遗漏，可以在修改完之后，到根目录下运行下述grep命令试试看，找不到相应的字符串即为全部替换完成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grep -ril xposed.prop</span><br><span class="line">grep -ril &quot;xposed.prop&quot; . ##过滤当前目录下含该字符串的文件</span><br></pre></td></tr></table></figure>

<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/44.png" alt="image-20211003152549464"></p>
<p>可是明明这里我是替换了的，我进入文件中也查找不到</p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/45.png" alt="image-20211003152549464"></p>
<p>经过分析，我们发现这里会将xposed_prop识别为xposed.prop，说明我们是替换完成了</p>
<h3 id="5-源码编译"><a href="#5-源码编译" class="headerlink" title="5.源码编译"></a>5.源码编译</h3><p>源码编译流程，详细的参考上文</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">（1）这里我们已经替换了art</span><br><span class="line">（2）记得将修改的xposed替换/SourceCode/Android-6.0.1_r1/frameworks/base/cmds/`文件夹下的xposed文件夹</span><br><span class="line">（3）还记得把编译出来的XppsedBridge.jar放到$AOSP/out/java/目录中去噢，替换旧的XposedBridge.jar</span><br></pre></td></tr></table></figure>

<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/46.png" alt="image-20211003152549464"></p>
<p>我们再次输入编译指令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./build.pl -t arm:23</span><br></pre></td></tr></table></figure>

<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/47.png" alt="image-20211003152549464"></p>
<p>编译成功，生成文件：</p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/48.png" alt="image-20211003152549464"></p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/49.png" alt="image-20211003152549464"></p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/50.png" alt="image-20211003152549464"></p>
<p>我们重新移动生成文件到源码文件夹下，具体参考上文：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp /home/tom/SourceCode/XposedBridge/sdk23/arm/files/system/bin<span class="comment">/* .</span></span><br><span class="line"><span class="comment">cp /home/tom/SourceCode/XposedBridge/sdk23/arm/files/system/lib/* .</span></span><br><span class="line"><span class="comment">cp /home/tom/SourceCode/XposedBridge/sdk23/arm/files/system/xppsed.prop  .</span></span><br></pre></td></tr></table></figure>

<p>记得将xposed编译生成的app_process32_xposed替换system&#x2F;bin文件夹下的app_process32</p>
<p>然后我们进入源码目录下，再次编译镜像：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">source build/envsetup.sh</span><br><span class="line">lunch 19</span><br><span class="line">make snod  //make snod命令的作用是重新生成镜像文件system.img</span><br></pre></td></tr></table></figure>

<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/51.png" alt="image-20211003165926906"></p>
<h3 id="6-结果与验证"><a href="#6-结果与验证" class="headerlink" title="6.结果与验证"></a>6.结果与验证</h3><h4 id="（1）结果"><a href="#（1）结果" class="headerlink" title="（1）结果"></a>（1）结果</h4><p>我们将镜像刷入手机：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastboot flash system system.img</span><br></pre></td></tr></table></figure>

<p>然后重启，发现Xposed安装成功</p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/52.png" alt="image-20211003165926906"></p>
<h4 id="（2）验证"><a href="#（2）验证" class="headerlink" title="（2）验证"></a>（2）验证</h4><p>我们下载<a target="_blank" rel="noopener" href="https://github.com/w568w/XposedChecker">XposedCheck</a>，这里我们从官网下载源码，用Android Studio打开，然后编译安装，发现我们定制Xposed框架成功</p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/53.png" alt="image-20211003165926906"></p>
<h3 id="7-错误"><a href="#7-错误" class="headerlink" title="7.错误"></a>7.错误</h3><h4 id="（1）错误1"><a href="#（1）错误1" class="headerlink" title="（1）错误1"></a>（1）错误1</h4><p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/54.png" alt="image-20211003165926906"></p>
<p>问题分析：</p>
<p>这是我们没有替换xposed导致的</p>
<p>问题解决：</p>
<p>我们将修改的Xposed替换原来<code>/SourceCode/Android-6.0.1_r1/frameworks/base/cmds/</code>文件夹下的xposed文件夹</p>
<h4 id="（2）错误2"><a href="#（2）错误2" class="headerlink" title="（2）错误2"></a>（2）错误2</h4><p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/55.png" alt="image-20211003165926906"></p>
<p>问题分析：</p>
<p>这是我们的Xposed文件夹首字母为大写导致</p>
<p>问题解决：</p>
<p>我们将其首字母改为小写</p>
<h4 id="（3）错误3"><a href="#（3）错误3" class="headerlink" title="（3）错误3"></a>（3）错误3</h4><p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/56.png" alt="image-20211003165926906"></p>
<p>错误分析：</p>
<p>这是xposedinstaller和XposedBridge版本不一致导致</p>
<p>问题解决：</p>
<p>匹配详细参考上文</p>
<h4 id="（4）错误4"><a href="#（4）错误4" class="headerlink" title="（4）错误4"></a>（4）错误4</h4><p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/57.png" alt="image-20211003165926906"></p>
<p>错误分析：</p>
<p><img src="https://pic-1307040378.cos.ap-chengdu.myqcloud.com/code4/58.png" alt="image-20211003165926906"></p>
<p>错误分析：</p>
<p>经过反复的检查，最后原来是XposedBridge.jar编译的问题</p>
<p>问题解决：</p>
<p>因为我们编译过程中，将这里给注释掉了 所以导致并没导入Android6.0的环境支持，我们需要加入支持，详细见上文</p>
<h2 id="六、实验总结"><a href="#六、实验总结" class="headerlink" title="六、实验总结"></a>六、实验总结</h2><p>经过几天的学习，处理完许许多多的bug，从源码分析到源码定制，花了一周终于将这几篇文章写完了，从中收获了很多，这中间参考了很多大佬的文章，在文中和参考文献中会一一列出来，如果其中还存在一些问题，就请各位大佬指正了。</p>
<h2 id="七、参考文献"><a href="#七、参考文献" class="headerlink" title="七、参考文献"></a>七、参考文献</h2><p>Android源码分析：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">https://juejin.cn/post/6844903748058218509、</span><br><span class="line">https://www.jianshu.com/p/2c0b76d0f4f2</span><br><span class="line">https://www.jianshu.com/p/8bb770ec4c48</span><br><span class="line">https://www.javatt.com/p/42078</span><br><span class="line">https://blog.csdn.net/luoshengyang/article/details/8852432</span><br><span class="line">https://blog.csdn.net/luoshengyang/article/details/8885792</span><br><span class="line">https://www.jianshu.com/p/89d06f626540</span><br><span class="line">https://www.wuyifei.cc/dex-vdex-odex-art/</span><br><span class="line">https://skytoby.github.io/2019/Android%20dex%EF%BC%8Codex%EF%BC%8Coat%EF%BC%8Cvdex%EF%BC%8Cart%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/</span><br><span class="line">https://cloud.tencent.com/developer/article/1755790</span><br><span class="line">https://www.kancloud.cn/alex_wsc/androids/473620</span><br></pre></td></tr></table></figure>

<p>Xposed：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">https://zhuanlan.zhihu.com/p/389889716</span><br><span class="line">https://www.bbsmax.com/A/MAzAq2Ynz9/</span><br><span class="line">https://www.cnblogs.com/baiqiantao/p/10699552.html</span><br><span class="line">https://www.jianshu.com/p/6b4a80654d4e</span><br><span class="line">http://www.uml.org.cn/mobiledev/201903052.asp</span><br><span class="line">https://bbs.pediy.com/thread-255836.htm</span><br><span class="line">https://mp.weixin.qq.com/s/YAMCrQSi0LFJGNIwB9qHDA</span><br></pre></td></tr></table></figure>


    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>安全后厨团队 |  微信公众号【安全后厨】
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://security-kitchen.com/2022/12/04/code4/" title="Android源码定制（4）——Xposed源码定制">http://security-kitchen.com/2022/12/04/code4/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E9%80%86%E5%90%91%E6%8A%80%E6%9C%AF/" rel="tag"># 逆向技术</a>
              <a href="/tags/Xposed/" rel="tag"># Xposed</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/12/04/code3/" rel="prev" title="Android源码定制（3）——Xposed源码编译详解">
      <i class="fa fa-chevron-left"></i> Android源码定制（3）——Xposed源码编译详解
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/12/05/code5/" rel="next" title="Android源码定制（5）——root指纹定制与抹除">
      Android源码定制（5）——root指纹定制与抹除 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E5%89%8D%E8%A8%80"><span class="nav-text">一、前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81Android%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6"><span class="nav-text">二、Android运行机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Android%E5%B9%B3%E5%8F%B0%E6%9E%B6%E6%9E%84"><span class="nav-text">1. Android平台架构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%881%EF%BC%89Linux%E5%86%85%E6%A0%B8"><span class="nav-text">（1）Linux内核</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E7%A1%AC%E4%BB%B6%E6%8A%BD%E8%B1%A1%E5%B1%82%EF%BC%88HAL%EF%BC%89"><span class="nav-text">（2）硬件抽象层（HAL）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%883%EF%BC%89Android-Runtime"><span class="nav-text">（3）Android Runtime</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%884%EF%BC%89%E5%8E%9F%E7%94%9FC-x2F-C-%E5%BA%93"><span class="nav-text">（4）原生C&#x2F;C++库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%885%EF%BC%89Java-API%E6%A1%86%E6%9E%B6"><span class="nav-text">（5）Java API框架</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Android%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B"><span class="nav-text">2. Android启动流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%881%EF%BC%89Loader"><span class="nav-text">（1）Loader</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%882%EF%BC%89Linux%E5%86%85%E6%A0%B8"><span class="nav-text">（2）Linux内核</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E6%89%A7%E8%A1%8Cinit%E8%BF%9B%E7%A8%8B"><span class="nav-text">（3）执行init进程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%884%EF%BC%89Zygote"><span class="nav-text">（4）Zygote</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81Xposed%E6%A1%86%E6%9E%B6%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6"><span class="nav-text">三、Xposed框架运行机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Xposed%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="nav-text">1.  Xposed实现原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Xposed-hook%E5%8E%9F%E7%90%86"><span class="nav-text">2. Xposed hook原理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E5%8F%96%E6%B6%88%E9%87%8D%E5%90%AF%E6%89%8B%E6%9C%BA"><span class="nav-text">（1）取消重启手机</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E5%8F%96%E6%B6%88%E6%93%8D%E4%BD%9CInstaller-APP"><span class="nav-text">（2）取消操作Installer APP</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E3%80%81Xposed%E6%A1%86%E6%9E%B6%E7%89%B9%E5%BE%81"><span class="nav-text">四、Xposed框架特征</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94%E3%80%81Xposed%E7%89%B9%E5%BE%81%E4%BF%AE%E6%94%B9"><span class="nav-text">五、Xposed特征修改</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-XposedInstaller"><span class="nav-text">1. XposedInstaller</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E4%BF%AE%E6%94%B9%E6%95%B4%E4%BD%93%E5%8C%85%E5%90%8D"><span class="nav-text">（1）修改整体包名</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%882%EF%BC%89xposed-prop%E6%94%B9%E6%88%90xpsed-prop"><span class="nav-text">（2）xposed.prop改成xpsed.prop</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-XposedBridge"><span class="nav-text">2. XposedBridge</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E4%BF%AE%E6%94%B9%E6%95%B4%E4%BD%93%E5%8C%85%E5%90%8D-1"><span class="nav-text">（1）修改整体包名</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E7%94%9F%E6%88%90%E6%96%87%E4%BB%B6"><span class="nav-text">（2）生成文件</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Xposed"><span class="nav-text">3. Xposed</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%881%EF%BC%89libxposed-common-h"><span class="nav-text">（1）libxposed_common.h</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%882%EF%BC%89Xposed-h"><span class="nav-text">（2）Xposed.h</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%883%EF%BC%89xposed-service-cpp"><span class="nav-text">（3）xposed_service.cpp</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%884%EF%BC%89xposed-shared-h"><span class="nav-text">（4）xposed_shared.h</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%885%EF%BC%89ART-mk"><span class="nav-text">（5）ART.mk</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%886%EF%BC%89libxposed-art-cpp"><span class="nav-text">（6）libxposed_art.cpp</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-XposedTools"><span class="nav-text">4. XposedTools</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91"><span class="nav-text">5.源码编译</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E7%BB%93%E6%9E%9C%E4%B8%8E%E9%AA%8C%E8%AF%81"><span class="nav-text">6.结果与验证</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E7%BB%93%E6%9E%9C"><span class="nav-text">（1）结果</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E9%AA%8C%E8%AF%81"><span class="nav-text">（2）验证</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-%E9%94%99%E8%AF%AF"><span class="nav-text">7.错误</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E9%94%99%E8%AF%AF1"><span class="nav-text">（1）错误1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E9%94%99%E8%AF%AF2"><span class="nav-text">（2）错误2</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E9%94%99%E8%AF%AF3"><span class="nav-text">（3）错误3</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%884%EF%BC%89%E9%94%99%E8%AF%AF4"><span class="nav-text">（4）错误4</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AD%E3%80%81%E5%AE%9E%E9%AA%8C%E6%80%BB%E7%BB%93"><span class="nav-text">六、实验总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%83%E3%80%81%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="nav-text">七、参考文献</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="安全后厨团队"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">安全后厨团队</p>
  <div class="site-description" itemprop="description">选择有时候比努力更重要</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">48</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/WindXaa" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;WindXaa" rel="noopener" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://bbs.pediy.com/user-home-905443.htm" title="看雪 → https:&#x2F;&#x2F;bbs.pediy.com&#x2F;user-home-905443.htm" rel="noopener" target="_blank"><i class="gratipay fa-fw"></i>看雪</a>
      </span>
  </div>



      </div>
	  
	  <div class="wechat_OA">
		<span><b>公众号</b></span>
		<br>
		<!-- 这里添加你的二维码图片 -->
		<img src="https://blog-1307040378.cos.ap-chengdu.myqcloud.com/blog-website/weChat.jpg" alt="二维码">
	  </div>
	  <div class="wechat_OA">
		<span><b>知识星球</b></span>
		<br>
		<!-- 这里添加你的二维码图片 -->
		<img src="https://blog-1307040378.cos.ap-chengdu.myqcloud.com/blog-website%2Fstar.png" alt="知识星球">
	  </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2022-12 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">安全后厨团队</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>
<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共184.3k字</span>
</div>

    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    <span id="busuanzi_container_site_pv">总访问量<span id="busuanzi_value_site_pv"></span>次</span>
    <span class="post-meta-divider">|</span>
    <span id="busuanzi_container_site_uv">总访客数<span id="busuanzi_value_site_uv"></span>人</span>
    <span class="post-meta-divider">|</span>
<!-- 不蒜子计数初始值纠正 -->
<script>
$(document).ready(function() {

    var int = setInterval(fixCount, 50);  // 50ms周期检测函数
    var countOffset = 20000;  // 初始化首次数据

    function fixCount() {            
       if (document.getElementById("busuanzi_container_site_pv").style.display != "none")
        {
            $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + countOffset); 
            clearInterval(int);
        }                  
        if ($("#busuanzi_container_site_pv").css("display") != "none")
        {
            $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + countOffset); // 加上初始数据 
            clearInterval(int); // 停止检测
        }  
    }
       	
});
</script> 


        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
